<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard เครื่องจักร</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>ระบบจัดการเครื่องจักรและยานพาหนะ</h2>
        
        <div class="dashboard-grid">
            <a href="info.html" class="card-menu c-blue">
                <i class="fas fa-truck-monster card-icon"></i>
                <div class="card-title">ข้อมูลเครื่องจักร</div>
                <div class="card-desc">ดูรายการรถและวันหมดอายุ</div>
            </a>

            <a href="fuel.html" class="card-menu c-orange">
                <i class="fas fa-gas-pump card-icon"></i>
                <div class="card-title">บันทึกน้ำมัน</div>
                <div class="card-desc">ตรวจสอบประวัติการเติมน้ำมัน</div>
            </a>

            <a href="repair.html" class="card-menu c-green">
                <i class="fas fa-tools card-icon"></i>
                <div class="card-title">บันทึกค่าซ่อม</div>
                <div class="card-desc">ประวัติการซ่อมบำรุง</div>
            </a>

            <a href="info.html" class="card-menu c-red">
                <div class="alert-badge" id="alert-badge">!</div>
                <i class="fas fa-calendar-alt card-icon"></i>
                <div class="card-title">แจ้งเตือนภาษี/พรบ.</div>
                <div class="card-desc" id="alert-text" style="line-height: 1.6;">กำลังตรวจสอบ...</div>
            </a>
        </div>
    </div>

    <script src="menu.js"></script>
    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=0&single=true&output=csv';

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data;
                let warningCount = 0; // ใกล้หมด (30 วัน)
                let expiredCount = 0; // หมดแล้ว
                const today = new Date();
                today.setHours(0,0,0,0);

                data.forEach(row => {
                    const checkDate = (dateString) => {
                        if(!dateString || dateString.trim() === '') return;
                        const parts = dateString.split('/');
                        if(parts.length !== 3) return;
                        
                        // แปลง string เป็น Date Object (ระวัง: เดือนเริ่มที่ 0)
                        const expiryDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        
                        // หาจำนวนวัน
                        const diffTime = expiryDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays < 0) {
                            expiredCount++;
                        } else if (diffDays >= 0 && diffDays <= 30) {
                            warningCount++;
                        }
                    };

                    checkDate(row['วันที่ทะเบียนขาด']);
                    checkDate(row['วันที่ประกัน+พรบ.ขาด']);
                });

                const alertText = document.getElementById('alert-text');
                const badge = document.getElementById('alert-badge');
                
                if (expiredCount > 0 || warningCount > 0) {
                    alertText.innerHTML = `<span style="color:#ef4444; font-weight:bold;">ขาดแล้ว: ${expiredCount} คัน</span><br><span style="color:#f59e0b; font-weight:bold;">ใกล้ขาด: ${warningCount} คัน</span>`;
                    badge.style.display = 'block';
                    badge.innerText = expiredCount + warningCount;
                } else {
                    alertText.innerHTML = '<span style="color:#10b981;">สถานะปกติ <br>ไม่มีรายการใกล้หมดอายุ</span>';
                }
            }
        });
    </script>
</body>
</html>