<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Machine Dashboard (Vue 3)</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* --- CORE STYLES (Kept Original for Consistency) --- */
        :root {
            --primary: #4f46e5;
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
        }

        body { font-family: 'Prompt', sans-serif; margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); padding-bottom: 50px; overflow-x: hidden; }
        
        /* Utility */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .hidden { display: none !important; }
        .cursor-pointer { cursor: pointer; }
        
        /* --- LOADER --- */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease-out; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e5e7eb; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVBAR --- */
        .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 0.8rem; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-wrap: wrap; }
        .nav-btn { border: none; background: transparent; cursor: pointer; color: var(--text-muted); padding: 8px 16px; border-radius: 50px; transition: 0.3s; font-family: 'Prompt', sans-serif; font-size: 0.95rem; display: flex; align-items: center; gap: 5px; }
        .nav-btn:hover { background: #eef2ff; color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }

        /* --- CONTAINER --- */
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; } 
        h2.page-title { text-align: center; margin-bottom: 30px; font-weight: 700; color: var(--text-main); }

        /* --- DASHBOARD GRID --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .menu-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start; position: relative; overflow: hidden; }
        .menu-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--color); }
        .menu-card h3 { margin: 0 0 5px 0; font-size: 1rem; color: var(--text-muted); font-weight: 500; }
        .menu-card .stat { font-size: 2rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .menu-card .desc { font-size: 0.85rem; color: #9ca3af; margin-top: 5px; }
        .menu-card .icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; background: var(--bg); color: var(--color); z-index: 2; }
        .menu-card .bg-icon { position: absolute; bottom: -20px; right: -20px; font-size: 8rem; opacity: 0.05; transform: rotate(-15deg); color: var(--color); z-index: 1; pointer-events: none; }
        .alert-row { display: flex; gap: 15px; margin-top: 10px; font-size: 1rem; font-weight: 600; }

        .c-blue { --color: #3b82f6; --bg: #eff6ff; } .c-orange { --color: #f59e0b; --bg: #fffbeb; }
        .c-green { --color: #10b981; --bg: #ecfdf5; } .c-red { --color: #ef4444; --bg: #fef2f2; }
        .c-purple { --color: #8b5cf6; --bg: #f3e8ff; } .c-cyan { --color: #06b6d4; --bg: #ecfeff; }
        .c-indigo { --color: #6366f1; --bg: #e0e7ff; }

        /* --- CONTROLS --- */
        .filter-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .controls-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .custom-select { padding: 8px 15px; border-radius: 50px; border: 1px solid #e5e7eb; font-family: 'Prompt', sans-serif; cursor: pointer; background: white; }
        .btn-back { padding: 8px 15px; border-radius: 50px; border: 1px solid #e5e7eb; background: white; cursor: pointer; display: flex; align-items: center; gap: 5px; font-family: 'Prompt', sans-serif; transition: 0.2s; }
        .btn-back:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #4338ca; }
        .search-input { padding: 8px 15px; border-radius: 50px; border: 1px solid #e5e7eb; width: 200px; font-family: 'Prompt', sans-serif; }

        /* --- CHARTS & LISTS --- */
        .charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .charts-wrapper { grid-template-columns: 1fr; } }
        
        .chart-box { background: white; border-radius: 20px; padding: 20px; height: 350px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .list-box { background: white; border-radius: 20px; padding: 15px; height: 350px; overflow-y: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .chart-internal-title { text-align: center; font-size: 1rem; color: var(--text-muted); font-weight: 600; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }

        .top10-list-container { flex: 1; overflow-y: auto; }
        .top10-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; align-items: center; }
        .top10-item:hover { background: #f8fafc; padding-left: 15px; }
        .top10-rank { font-weight: bold; color: #cbd5e1; width: 25px; }

        /* Card List */
        .card-list { display: flex; flex-direction: column; gap: 10px; }
        .item-card { background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
        .item-card:hover { transform: translateX(3px); border-color: #cbd5e1; }
        .item-card-left { display: flex; align-items: center; gap: 15px; }
        .item-icon { font-size: 1.5rem; opacity: 0.5; }

        /* Info Card */
        .info-card-list { display: flex; flex-direction: column; gap: 12px; }
        .info-card { background: white; border-radius: 16px; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; border-left: 6px solid transparent; transition: all 0.2s; cursor: pointer; }
        .info-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        
        /* Vehicle Detail */
        .vehicle-view { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .vv-header { display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .vv-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #f9fafb; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .vv-stat { display: flex; flex-direction: column; }
        .vv-stat label { font-size: 0.85rem; color: #64748b; display: block; }
        .vv-stat span { font-weight: 600; font-size: 1.1rem; color: var(--text-main); }
        .vv-actions { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .vv-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .vv-charts { grid-template-columns: 1fr; } }
        .vv-title-group { display: flex; align-items: center; gap: 15px; }
        .vv-icon-box { width: 60px; height: 60px; background: #eef2ff; color: var(--primary); border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
        
        .alert-badge-btn { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 6px 12px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .alert-badge-btn:hover { background: #fecaca; }

        .repair-alert-item { background: #fff5f5; border-left: 4px solid #ef4444; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .ra-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
        .ra-details { font-size: 0.9rem; color: #6b7280; }
        .ra-btn { background: var(--success); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; }

        .calc-box { background: white; padding: 30px; border-radius: 20px; max-width: 400px; margin: 0 auto; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-family: 'Prompt'; box-sizing: border-box; }
        
        .summary-box { text-align: right; margin-bottom: 10px; font-size: 1.1rem; color: #666; }
        .summary-val { font-weight: 700; font-size: 1.4rem; }
        .project-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #e5e7eb; box-shadow: var(--shadow-sm); cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .project-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-color: var(--primary); }
    </style>
</head>
<body>
    <div id="app">
        <!-- LOADER -->
        <div id="loading-overlay" v-if="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">กำลังเชื่อมต่อฐานข้อมูล...</p>
        </div>

        <!-- NAVBAR -->
        <nav class="navbar" id="main-navbar" v-if="!loading">
            <button class="nav-btn" :class="{active: currentPage === 'home'}" @click="nav('home')"><i class="fas fa-home"></i> หน้าหลัก</button>
            <button class="nav-btn" :class="{active: currentPage === 'info'}" @click="nav('info')"><i class="fas fa-truck"></i> ข้อมูลรถ</button>
            <button class="nav-btn" :class="{active: currentPage === 'projects'}" @click="nav('projects')"><i class="fas fa-project-diagram"></i> โครงการ</button>
            <button class="nav-btn" :class="{active: currentPage === 'shops'}" @click="nav('shops')"><i class="fas fa-store"></i> อู่/ร้านซ่อม</button>
            <button class="nav-btn" :class="{active: currentPage === 'fuel'}" @click="nav('fuel')"><i class="fas fa-gas-pump"></i> น้ำมัน</button>
            <button class="nav-btn" :class="{active: currentPage === 'repair'}" @click="nav('repair')"><i class="fas fa-tools"></i> ซ่อมบำรุง</button>
            <button class="nav-btn" :class="{active: currentPage === 'alerts'}" @click="nav('alerts')"><i class="fas fa-bell"></i> แจ้งเตือน</button>
            <button class="nav-btn" :class="{active: currentPage === 'calc'}" @click="nav('calc')" style="color: #8b5cf6;"><i class="fas fa-calculator"></i> คำนวณ</button>
        </nav>

        <!-- CONTAINER -->
        <div class="container fade-in" v-if="!loading">

            <!-- 1. DASHBOARD -->
            <div v-if="currentPage === 'home'" class="page-section active">
                <h2 class="page-title">ภาพรวมสถานะเครื่องจักร</h2>
                <div class="dashboard-grid">
                    <div class="menu-card c-blue" @click="nav('info')">
                        <div><h3>จำนวนเครื่องจักร</h3><div class="stat">{{ dInfo.length }}</div><div class="desc">รายการทะเบียนทั้งหมด</div></div>
                        <div class="icon-box"><i class="fas fa-truck"></i></div><i class="fas fa-truck bg-icon"></i>
                    </div>
                    <div class="menu-card c-indigo" @click="nav('projects')">
                        <div><h3>โครงการทั้งหมด</h3><div class="stat">{{ Object.keys(dProjects).length }}</div><div class="desc">สรุปภาพรวมโครงการ</div></div>
                        <div class="icon-box"><i class="fas fa-project-diagram"></i></div><i class="fas fa-project-diagram bg-icon"></i>
                    </div>
                    <div class="menu-card c-orange" @click="nav('fuel')">
                        <div><h3>น้ำมันรวม</h3><div class="stat">{{ totalFuel.toLocaleString() }}</div><div class="desc">ลิตร (สะสม)</div></div>
                        <div class="icon-box"><i class="fas fa-gas-pump"></i></div><i class="fas fa-gas-pump bg-icon"></i>
                    </div>
                    <div class="menu-card c-green" @click="nav('repair')">
                        <div><h3>ค่าซ่อมรวม</h3><div class="stat">{{ totalRepair.toLocaleString() }}</div><div class="desc">บาท (สะสม)</div></div>
                        <div class="icon-box"><i class="fas fa-tools"></i></div><i class="fas fa-tools bg-icon"></i>
                    </div>
                    <div class="menu-card c-cyan" @click="nav('shops')">
                        <div><h3>รายชื่อร้าน/อู่</h3><div class="stat">{{ Object.keys(dShops).length }}</div><div class="desc">สถานที่ซื้อ/ซ่อมบำรุง</div></div>
                        <div class="icon-box"><i class="fas fa-store"></i></div><i class="fas fa-store bg-icon"></i>
                    </div>
                    <div class="menu-card c-red" @click="nav('alerts')">
                        <div><h3>แจ้งเตือนภาษี</h3><div class="alert-row"><span style="color:var(--danger)">ขาด {{ countExp }}</span> / <span style="color:var(--warning)">ใกล้ {{ countNear }}</span></div><div class="desc">กดเพื่อจัดการ</div></div>
                        <div class="icon-box"><i class="fas fa-bell"></i></div><i class="fas fa-bell bg-icon"></i>
                    </div>
                    <div class="menu-card c-red" style="--color:var(--danger); --bg:#fef2f2;" @click="openRepeatModal">
                        <div><h3>ซ่อมซ้ำ (90 วัน)</h3><div class="stat" style="color:var(--danger)">{{ repeatList.length }}</div><div class="desc">รายการที่ต้องตรวจสอบ</div></div>
                        <div class="icon-box"><i class="fas fa-exclamation-triangle"></i></div><i class="fas fa-exclamation-triangle bg-icon"></i>
                    </div>
                    <div class="menu-card c-purple" @click="nav('calc')">
                        <div><h3>เครื่องมือ</h3><div class="stat" style="font-size:1.5rem">Prorate</div><div class="desc">คำนวณค่าใช้จ่าย</div></div>
                        <div class="icon-box"><i class="fas fa-calculator"></i></div><i class="fas fa-calculator bg-icon"></i>
                    </div>
                </div>
            </div>

            <!-- 2. INFO -->
            <div v-if="currentPage === 'info'" class="page-section active">
                <div v-if="!selectedCar">
                    <div class="filter-bar"><h2 style="margin:0">ข้อมูลรถ</h2><input type="text" v-model="searchInfo" class="search-input" placeholder="ค้นหาทะเบียน..."></div>
                    <div class="info-card-list">
                        <div v-for="c in filteredInfo" :key="c.id" class="info-card" :style="{borderLeft: '5px solid ' + getStatusColor(c.tax)}" @click="viewCar(c)">
                            <div class="item-card-left">
                                <div class="icon-box" :style="{width:'40px', height:'40px', fontSize:'1.2rem', background:getStatusColor(c.tax)+'20', color:getStatusColor(c.tax), borderRadius:'10px', display:'flex', alignItems:'center', justifyContent:'center'}"><i class="fas fa-truck"></i></div>
                                <div><div style="font-weight:bold">{{ c.id }}</div><div style="font-size:0.85rem;color:#666">{{ c.plate }}</div></div>
                            </div>
                            <div class="text-right"><div style="font-size:0.8rem;color:#999">ภาษี</div><div style="font-weight:600;" :style="{color:getStatusColor(c.tax)}">{{ c.tax||'-' }}</div></div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="vehicle-view" style="display:block;">
                    <div class="vv-header">
                        <div><h2 style="margin:0; color:var(--primary)">{{ selectedCar.id }}</h2><span style="color:#666">{{ selectedCar.plate }}</span></div>
                        <button class="btn-back" @click="selectedCar = null"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                    </div>
                    <div class="vv-info-grid">
                        <div class="vv-stat"><label>ยี่ห้อ</label><span>{{ selectedCar.brand }}</span></div>
                        <div class="vv-stat"><label>ประเภท</label><span>{{ selectedCar.type }}</span></div>
                        <div class="vv-stat"><label>ภาษีหมดอายุ</label><span v-html="formatTax(selectedCar.tax)"></span></div>
                    </div>
                    <div class="vv-actions">
                        <button class="btn-back" style="background:#fff7ed; color:#d97706;" @click="openHistory('fuel')">ประวัติน้ำมัน</button>
                        <button class="btn-back" style="background:#f0fdf4; color:#059669;" @click="openHistory('repair')">ประวัติซ่อม</button>
                    </div>
                    <div class="vv-charts">
                        <div class="chart-box" style="display:flex; flex-direction:column;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div class="chart-internal-title" style="margin:0; color:#f59e0b; border:none; padding-bottom:0;">สถิติน้ำมัน ({{ infoFuelScope.title }})</div>
                                <button v-if="infoFuelScope.mode !== 'year'" class="btn-back" @click="upScope('infoFuel')" style="padding:4px 12px; font-size:0.8rem;"><i class="fas fa-arrow-up"></i> กลับ</button>
                            </div>
                            <div style="flex-grow:1; position:relative;"><canvas ref="infoFuelChart"></canvas></div>
                        </div>
                        <div class="chart-box" style="display:flex; flex-direction:column;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div class="chart-internal-title" style="margin:0; color:#10b981; border:none; padding-bottom:0;">สถิติซ่อมบำรุง ({{ infoRepairScope.title }})</div>
                                <button v-if="infoRepairScope.mode !== 'year'" class="btn-back" @click="upScope('infoRepair')" style="padding:4px 12px; font-size:0.8rem;"><i class="fas fa-arrow-up"></i> กลับ</button>
                            </div>
                            <div style="flex-grow:1; position:relative;"><canvas ref="infoRepairChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. PROJECTS -->
            <div v-if="currentPage === 'projects'" class="page-section active">
                <div v-if="!selectedProject">
                    <div class="filter-bar"><h2 style="margin:0; color:var(--primary)">โครงการทั้งหมด</h2></div>
                    <div class="info-card-list">
                        <div v-for="(p, name) in dProjects" :key="name" class="project-card" @click="viewProject(name)">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div class="icon-box" style="width:45px;height:45px;background:#e0e7ff;color:var(--primary);font-size:1.2rem;display:flex;justify-content:center;align-items:center;border-radius:10px;"><i class="fas fa-folder"></i></div>
                                <div style="font-weight:bold;font-size:1.1rem;color:#333;">{{ name }}</div>
                            </div>
                            <div class="text-right">
                                <div style="font-size:0.85rem;color:#666;">น้ำมัน: <span style="color:#f59e0b;font-weight:600;">{{ p.fuel.toLocaleString() }}</span> ลิตร</div>
                                <div style="font-size:0.85rem;color:#666;">ซ่อม: <span style="color:#10b981;font-weight:600;">{{ p.repair.toLocaleString() }}</span> บ.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="vehicle-view" style="display:block;">
                    <div class="vv-header">
                        <div class="vv-title-group">
                            <div class="vv-icon-box" style="background:#e0e7ff; color:var(--primary);"><i class="fas fa-project-diagram"></i></div>
                            <div><h2 style="margin:0; color:var(--primary)">{{ selectedProject }}</h2><span style="color:#666">รายละเอียดโครงการ</span></div>
                        </div>
                        <button class="btn-back" @click="selectedProject = null"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                    </div>
                    <div class="vv-info-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="vv-stat"><label>น้ำมันรวม (ลิตร)</label><span style="color:#f59e0b">{{ dProjects[selectedProject].fuel.toLocaleString() }}</span></div>
                        <div class="vv-stat"><label>ค่าซ่อมรวม (บาท)</label><span style="color:#10b981">{{ dProjects[selectedProject].repair.toLocaleString() }}</span></div>
                    </div>
                    <div class="vv-charts">
                        <div class="chart-box" style="display:flex; flex-direction:column;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div class="chart-internal-title" style="margin:0; color:#f59e0b; border:none; padding-bottom:0;">น้ำมัน ({{ projFuelScope.title }})</div>
                                <button v-if="projFuelScope.mode !== 'year'" class="btn-back" @click="upScope('projFuel')" style="padding:4px 12px; font-size:0.8rem;"><i class="fas fa-arrow-up"></i> กลับ</button>
                            </div>
                            <div style="flex-grow:1; position:relative;"><canvas ref="projFuelChart"></canvas></div>
                        </div>
                        <div class="chart-box" style="display:flex; flex-direction:column;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div class="chart-internal-title" style="margin:0; color:#10b981; border:none; padding-bottom:0;">ซ่อมบำรุง ({{ projRepairScope.title }})</div>
                                <button v-if="projRepairScope.mode !== 'year'" class="btn-back" @click="upScope('projRepair')" style="padding:4px 12px; font-size:0.8rem;"><i class="fas fa-arrow-up"></i> กลับ</button>
                            </div>
                            <div style="flex-grow:1; position:relative;"><canvas ref="projRepairChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. SHOPS -->
            <div v-if="currentPage === 'shops'" class="page-section active">
                <div v-if="!selectedShop">
                    <div class="filter-bar"><h2 style="margin:0; color:#06b6d4;">รายชื่ออู่/ร้านซ่อม</h2><input type="text" v-model="searchShop" class="search-input" placeholder="ค้นหาร้าน..."></div>
                    <div class="info-card-list">
                        <div v-for="(s, name) in filteredShops" :key="name" class="info-card" style="border-left:5px solid #06b6d4" @click="viewShop(name)">
                            <div class="item-card-left">
                                <div class="icon-box" style="width:45px;height:45px;font-size:1.2rem;background:#ecfeff;color:#06b6d4;border-radius:12px;display:flex;align-items:center;justify-content:center;"><i class="fas fa-store"></i></div>
                                <div><div style="font-weight:bold">{{ name }}</div><div style="font-size:0.85rem;color:#666"><i class="fas fa-phone"></i> {{ s.phone || 'ไม่มีเบอร์' }}</div></div>
                            </div>
                            <div class="text-right">
                                <div style="font-size:0.8rem;color:#999">{{ s.count }} รายการ</div>
                                <div style="font-weight:600;color:#06b6d4">{{ s.total.toLocaleString() }} บ.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-else class="vehicle-view" style="display:block;">
                    <div class="vv-header">
                        <div class="vv-title-group">
                            <div class="vv-icon-box" style="background:#ecfeff; color:#06b6d4;"><i class="fas fa-store"></i></div>
                            <div><h2 style="margin:0; color:#06b6d4">{{ selectedShop }}</h2><span style="color:#666; font-weight:bold;">{{ dShops[selectedShop].phone ? '☎️ ' + dShops[selectedShop].phone : '' }}</span></div>
                        </div>
                        <button class="btn-back" @click="selectedShop = null"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                    </div>
                    <div class="filter-bar" style="background:#f8fafc; padding:15px; border-radius:15px;">
                        <div class="controls-group" style="width:100%;">
                            <input type="text" v-model="shopFilterCar" class="search-input" placeholder="ค้นหารหัสรถ..." style="flex-grow:1;">
                            <input type="month" v-model="shopFilterMonth" class="custom-select">
                            <button class="btn-back" @click="shopFilterCar=''; shopFilterMonth='';">ล้างตัวกรอง</button>
                        </div>
                    </div>
                    <div class="summary-box">ยอดรวม (ตามตัวกรอง): <span style="color:#06b6d4" class="summary-val">{{ filteredShopRecords.reduce((a,b)=>a+parse(b['ค่าใช้จ่าย']),0).toLocaleString() }}</span> บาท</div>
                    <div class="card-list" style="margin-top:15px; max-height:500px; overflow-y:auto; padding-right:5px;">
                        <div v-if="filteredShopRecords.length === 0" style="text-align:center; padding:20px; color:#999;">ไม่พบรายการซ่อมตามเงื่อนไขที่ระบุ</div>
                        <div v-for="r in filteredShopRecords" :key="r['วันที่']+r['รหัสรถ']+r.item" class="item-card" @click="viewCarById(r['รหัสรถ'])">
                            <div class="item-card-left">
                                <i class="fas fa-tools item-icon" style="color:#06b6d4;"></i>
                                <div>
                                    <div style="font-weight:bold">{{ r['รหัสรถ'] }} <span style="font-size:0.8rem; color:#9ca3af; font-weight:normal;">{{ r['วันที่'] }}</span></div>
                                    <div style="font-size:0.85rem; color:#666">{{ r.item || '-' }}</div>
                                </div>
                            </div>
                            <div style="font-weight:bold; color:#06b6d4">{{ parse(r['ค่าใช้จ่าย']).toLocaleString() }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. FUEL & REPAIR (Generic Components for reuse logic) -->
            <div v-for="type in ['fuel', 'repair']" :key="type">
                <div v-if="currentPage === type" class="page-section active">
                    <!-- Main View -->
                    <div v-if="!selectedDetailList && !selectedVehicleFromChart">
                        <div class="filter-bar">
                            <h2 style="margin:0;" :style="{color: type==='fuel'?'#f59e0b':'#10b981'}">สถิติ{{ type==='fuel'?'น้ำมัน':'ซ่อมบำรุง' }}</h2>
                            <div class="controls-group">
                                <button v-if="type==='repair' && repeatList.length > 0" class="alert-badge-btn" @click="openRepeatModal"><i class="fas fa-exclamation-triangle"></i> ซ้ำ {{ repeatList.length }}</button>
                                <select v-model="scopes[type].projectFilter" class="custom-select">
                                    <option value="all">ทุกโครงการ</option>
                                    <option v-for="p in Object.keys(dProjects)" :value="p" :key="p">{{ p }}</option>
                                </select>
                                <button v-if="scopes[type].mode !== 'year'" class="btn-back" @click="upScope(type)">กลับ</button>
                            </div>
                        </div>
                        <div class="summary-box">รวม: <span class="summary-val" :style="{color: type==='fuel'?'#f59e0b':'#10b981'}">{{ scopes[type].sum.toLocaleString() }}</span> {{ type==='fuel'?'ลิตร':'บาท' }}</div>
                        <div class="charts-wrapper">
                            <div class="chart-box">
                                <div class="chart-internal-title">ภาพรวม{{ scopes[type].title }}</div>
                                <div style="flex-grow:1; position:relative; height:85%;"><canvas :ref="type+'Chart'"></canvas></div>
                            </div>
                            <div class="list-box">
                                <div class="chart-internal-title">Top 10 ({{ type==='fuel'?'ลิตร':'บาท' }})</div>
                                <div class="top10-list-container">
                                    <div v-for="(item, idx) in scopes[type].top10" :key="item.id" class="top10-item" @click="viewVehicleFromChart(type, item.id)">
                                        <span class="top10-rank">{{ idx+1 }}</span>
                                        <span class="top10-id">{{ item.id }}</span>
                                        <span class="top10-vol" :style="{color: type==='fuel'?'#f59e0b':'#10b981'}">{{ item.val.toLocaleString() }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detail List View (Day level) -->
                    <div v-if="selectedDetailList" class="card-list">
                         <div class="filter-bar" style="margin-bottom:10px;">
                             <button class="btn-back" @click="selectedDetailList = null">ย้อนกลับ</button>
                             <h3 style="margin:0;">รายการวันที่ {{ selectedDetailDate }}</h3><div></div>
                         </div>
                         <div v-for="r in selectedDetailList" class="item-card" @click="viewVehicleFromChart(type, r['รหัสรถ'])">
                            <div class="item-card-left">
                                <i class="fas item-icon" :class="type==='fuel'?'fa-gas-pump':'fa-tools'" :style="{color: type==='fuel'?'#f59e0b':'#10b981'}"></i>
                                <div>
                                    <div style="font-weight:bold">{{ r['รหัสรถ'] }}</div>
                                    <div style="font-size:0.85rem; color:#666" v-html="type==='repair' ? (r.item + (r.place?' <span style=\'color:#94a3b8\'>['+r.place+']</span>':'')) : r['โครงการ']"></div>
                                </div>
                            </div>
                            <div style="font-weight:bold" :style="{color: type==='fuel'?'#f59e0b':'#10b981'}">{{ parse(r[type==='fuel'?'ปริมาณ(ลิตร)':'ค่าใช้จ่าย']).toLocaleString() }}</div>
                        </div>
                    </div>

                    <!-- Vehicle Chart View (Drilldown) -->
                    <div v-if="selectedVehicleFromChart" class="vehicle-view" style="display:block;">
                        <div class="vv-header">
                            <div><h2 style="margin:0; color:var(--primary)">{{ selectedVehicleFromChart.id }}</h2><span style="color:#666">{{ selectedVehicleFromChart.plate }}</span></div>
                            <button class="btn-back" @click="selectedVehicleFromChart = null">ย้อนกลับ</button>
                        </div>
                        <div class="vv-actions"><button class="btn-back" @click="viewCarById(selectedVehicleFromChart.id)">ดูข้อมูลรถคันนี้</button></div>
                        <div class="chart-box" style="display:flex; flex-direction:column;">
                             <div class="chart-internal-title" style="margin-bottom:10px;">สถิติ{{ type==='fuel'?'น้ำมัน':'ซ่อมบำรุง' }} (รายปี)</div>
                             <div style="flex-grow:1; position:relative;"><canvas :ref="type+'VehicleChart'"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. ALERTS -->
            <div v-if="currentPage === 'alerts'" class="page-section active">
                <div class="filter-bar"><h2 style="margin:0">จัดการข้อมูล</h2><div class="controls-group"><input type="text" v-model="searchAlerts" class="search-input" placeholder="ค้นหาทะเบียน/รหัส..."><button class="btn-primary" @click="openEditModal(null)">+ เพิ่มรถ</button></div></div>
                <div class="list-box" style="height:auto; min-height:500px;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead style="background:#f9fafb;"><tr style="text-align:left;"><th style="padding:12px;">รหัส</th><th>ทะเบียน</th><th>ภาษี</th><th>แก้ไข</th></tr></thead>
                        <tbody>
                            <tr v-for="c in filteredAlerts" :key="c.id" style="border-bottom:1px solid #eee;">
                                <td style="padding:10px;">{{ c.id }}</td>
                                <td>{{ c.plate }}</td>
                                <td v-html="formatTax(c.tax)"></td>
                                <td><button class="btn-back" @click="openEditModal(c)" style="padding:5px 10px"><i class="fas fa-edit"></i></button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 7. CALC -->
            <div v-if="currentPage === 'calc'" class="page-section active">
                <h2 class="page-title">เครื่องมือคำนวณ Prorate</h2>
                <div class="calc-box">
                    <label>วันที่เริ่ม</label><input type="date" v-model="calcStart" class="form-control">
                    <label>ยอดรวม</label><input type="number" v-model="calcAmount" class="form-control" placeholder="0.00">
                    <button class="btn-primary" style="margin-top:15px;" @click="doCalc">คำนวณ</button>
                    <div v-if="calcResult" style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                        <p>ปี 1: <strong>{{ calcResult.res1 }}</strong></p>
                        <p>ปี 2: <strong>{{ calcResult.res2 }}</strong></p>
                    </div>
                </div>
            </div>

        </div> <!-- End Container -->

        <!-- MODALS -->
        
        <!-- History Modal -->
        <div v-if="showHistoryModal" class="modal">
            <div class="modal-box">
                <span class="modal-close" @click="showHistoryModal = false">&times;</span>
                <h3 style="margin-top:0;">{{ historyType==='fuel'?'ประวัติน้ำมัน':'ประวัติซ่อมบำรุง' }}</h3>
                <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                    <div v-if="historyData.length===0">ไม่มีข้อมูล</div>
                    <div v-for="r in historyData" class="item-card" :class="{ 'cursor-pointer': historyType==='repair' && r.place }" @click="historyType==='repair' && r.place && viewShopFromHistory(r.place)">
                        <div class="item-card-left">
                            <i class="fas item-icon" :class="historyType==='fuel'?'fa-gas-pump':'fa-tools'" :style="{color: historyType==='fuel'?'#f59e0b':'#10b981'}"></i>
                            <div><div style="font-weight:bold">{{ r['วันที่'] }}</div><div style="font-size:0.85rem;color:#666" v-html="historyType==='fuel' ? (r['โครงการ']||'-') : (r.item + (r.place ? '['+r.place+']':''))"></div></div>
                        </div>
                        <div style="font-weight:bold;font-size:1.1rem;" :style="{color: historyType==='fuel'?'#f59e0b':'#10b981'}">{{ parse(historyType==='fuel'?r['ปริมาณ(ลิตร)']:r['ค่าใช้จ่าย']).toLocaleString() }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Repeat Repair Modal -->
        <div v-if="showRepeatModal" class="modal">
            <div class="modal-box">
                <span class="modal-close" @click="showRepeatModal = false">&times;</span>
                <h3 style="color:var(--danger); margin-top:0;">รายการซ่อมซ้ำ (90 วัน)</h3>
                <div v-if="repeatList.length===0" style='text-align:center; padding:20px; color:#666;'>ไม่พบรายการซ่อมซ้ำซ้อนใน 90 วัน</div>
                <div v-else>
                    <div v-for="x in repeatList" class="repair-alert-item">
                        <div style="font-weight:bold; display:flex; justify-content:space-between;"><span>{{ x.id }}</span> <span>{{ x.item }}</span></div>
                        <div style="font-size:0.9rem; color:#666; margin-top:5px;">ล่าสุด: {{ x.d1 }} <br><span style="color:red">ก่อนหน้า: {{ x.d2 }}</span></div>
                        <button class="ra-btn" @click="checkOff(x)">✅ รับทราบ (ตรวจสอบแล้ว)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div v-if="showEditModal" class="modal">
            <div class="modal-box">
                <span class="modal-close" @click="showEditModal = false">&times;</span>
                <h3 style="margin-top:0;">จัดการข้อมูล</h3>
                <form @submit.prevent="saveCar">
                    <label>รหัสรถ</label><input v-model="editForm.id" class="form-control" placeholder="รหัสรถ" required :disabled="editForm.mode === 'update'">
                    <label>ทะเบียน</label><input v-model="editForm.plate" class="form-control" placeholder="ทะเบียน">
                    <label>ยี่ห้อ</label><input v-model="editForm.brand" class="form-control" placeholder="ยี่ห้อ" list="dl-brand">
                    <label>ประเภท</label><input v-model="editForm.type" class="form-control" placeholder="ประเภท" list="dl-type">
                    <label>วันหมดภาษี</label><input v-model="editForm.tax" class="form-control" placeholder="วันหมดภาษี (DD/MM/YYYY)">
                    <button type="submit" class="btn-primary">{{ editForm.submitting ? 'กำลังบันทึก...' : 'บันทึก' }}</button>
                    <button type="button" v-if="editForm.mode==='update'" class="btn-primary" style="background:#fee2e2; color:red; margin-top:10px;" @click="delCar">ลบ</button>
                </form>
                <datalist id="dl-brand"><option v-for="b in uniqueBrands" :value="b"></option></datalist>
                <datalist id="dl-type"><option v-for="t in uniqueTypes" :value="t"></option></datalist>
            </div>
        </div>

    </div> <!-- End App -->

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // --- CONFIG ---
                const GAS_URL = 'https://script.google.com/macros/s/AKfycbz9knQB2Sptv6XiIICRLdGt-aUqt1ixteGmn-2mXNNIaECYJq66fR1LMjyoSm7bNglb/exec';
                const INFO_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=0&single=true&output=csv';
                const FUEL_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=700157187&single=true&output=csv';
                const REPAIR_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=1964968763&single=true&output=csv';
                const MONTHS = ["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."];

                // --- STATE ---
                const loading = ref(true);
                const currentPage = ref('home');
                const dInfo = ref([]);
                const dFuel = ref([]);
                const dRepair = ref([]);
                const chartInstances = {}; // Store charts non-reactively

                // Navigation State
                const selectedCar = ref(null);
                const selectedProject = ref(null);
                const selectedShop = ref(null);
                const searchInfo = ref('');
                const searchShop = ref('');
                const searchAlerts = ref('');
                
                // Modals
                const showHistoryModal = ref(false);
                const showRepeatModal = ref(false);
                const showEditModal = ref(false);
                const historyType = ref(''); // 'fuel' or 'repair'
                const editForm = ref({ mode: 'add', id: '', plate: '', brand: '', type: '', tax: '', submitting: false });
                
                // Chart Scopes (Single source of truth for drilldowns)
                const infoFuelScope = ref({ mode: 'year', year: null, month: null, title: 'รายปี' });
                const infoRepairScope = ref({ mode: 'year', year: null, month: null, title: 'รายปี' });
                const projFuelScope = ref({ mode: 'year', year: null, month: null, title: 'รายปี' });
                const projRepairScope = ref({ mode: 'year', year: null, month: null, title: 'รายปี' });
                
                // Main Fuel/Repair Page State
                const scopes = ref({
                    fuel: { mode: 'year', year: null, month: null, title: 'รายปี', sum: 0, top10: [], projectFilter: 'all' },
                    repair: { mode: 'year', year: null, month: null, title: 'รายปี', sum: 0, top10: [], projectFilter: 'all' }
                });
                const selectedDetailList = ref(null);
                const selectedDetailDate = ref('');
                const selectedVehicleFromChart = ref(null);

                // Shop Filter State
                const shopFilterCar = ref('');
                const shopFilterMonth = ref('');
                
                // Calc State
                const calcStart = ref(new Date().toISOString().split('T')[0]);
                const calcAmount = ref('');
                const calcResult = ref(null);

                // --- COMPUTED ---
                const totalFuel = computed(() => dFuel.value.reduce((a,b)=>a+parse(b['ปริมาณ(ลิตร)']),0));
                const totalRepair = computed(() => dRepair.value.reduce((a,b)=>a+parse(b['ค่าใช้จ่าย']),0));
                
                const dProjects = computed(() => {
                    let map = {};
                    dRepair.value.forEach(r => {
                         let p = r['โครงการ'] || 'ไม่ระบุ';
                         if(!map[p]) map[p] = {fuel:0, repair:0};
                         map[p].repair += parse(r['ค่าใช้จ่าย']);
                    });
                    dFuel.value.forEach(r => {
                         let p = r['โครงการ'] || 'ไม่ระบุ';
                         if(!map[p]) map[p] = {fuel:0, repair:0};
                         map[p].fuel += parse(r['ปริมาณ(ลิตร)']);
                    });
                    return map;
                });

                const dShops = computed(() => {
                    let map = {};
                    dRepair.value.forEach(r => {
                        let name = (r.place||'').trim();
                        if(name) {
                            if(!map[name]) map[name] = { phone:'', count:0, total:0 };
                            map[name].count++;
                            map[name].total += parse(r['ค่าใช้จ่าย']);
                            if(r.phone) map[name].phone = r.phone;
                        }
                    });
                    return map;
                });

                const repeatList = computed(() => {
                    let list = [], map = {};
                    dRepair.value.forEach(r => {
                        if(r.checked !== 'เช็คแล้ว' && r['รหัสรถ']) {
                            if(!map[r['รหัสรถ']]) map[r['รหัสรถ']] = [];
                            map[r['รหัสรถ']].push(r);
                        }
                    });
                    for(let id in map) {
                        let sorted = map[id].sort((a,b)=>toDate(b['วันที่'])-toDate(a['วันที่']));
                        for(let i=0; i<sorted.length; i++) {
                            for(let j=i+1; j<sorted.length; j++) {
                                let diff = (toDate(sorted[i]['วันที่']) - toDate(sorted[j]['วันที่'])) / 86400000;
                                if(diff > 90) break;
                                if((sorted[i].item||'').trim() === (sorted[j].item||'').trim()) {
                                    list.push({ id, item: sorted[i].item, d1: sorted[i]['วันที่'], d2: sorted[j]['วันที่'] });
                                }
                            }
                        }
                    }
                    return list;
                });

                const countExp = computed(() => dInfo.value.filter(c => checkDate(c.tax)==='exp').length);
                const countNear = computed(() => dInfo.value.filter(c => checkDate(c.tax)==='near').length);

                const filteredInfo = computed(() => {
                    let t = searchInfo.value.toLowerCase();
                    return dInfo.value.filter(c => c.id.toLowerCase().includes(t) || c.plate.toLowerCase().includes(t));
                });

                const filteredShops = computed(() => {
                    let t = searchShop.value.toLowerCase();
                    let res = {};
                    for(let name in dShops.value) {
                        if(name.toLowerCase().includes(t)) res[name] = dShops.value[name];
                    }
                    return res;
                });

                const filteredShopRecords = computed(() => {
                     if(!selectedShop.value) return [];
                     let list = dRepair.value.filter(r => (r.place||'').trim() === selectedShop.value);
                     if(shopFilterCar.value) list = list.filter(r => (r['รหัสรถ']||'').toLowerCase().includes(shopFilterCar.value.toLowerCase()));
                     if(shopFilterMonth.value) {
                         let [y, m] = shopFilterMonth.value.split('-');
                         list = list.filter(r => { let d=toDate(r['วันที่']); return d.getFullYear()==y && d.getMonth()+1==m; });
                     }
                     return list.sort((a,b)=>toDate(b['วันที่'])-toDate(a['วันที่']));
                });

                const filteredAlerts = computed(() => {
                    let t = searchAlerts.value.toLowerCase();
                    return dInfo.value.filter(c => {
                        let st = checkDate(c.tax);
                        return st !== 'ok' && (c.id.toLowerCase().includes(t) || c.plate.toLowerCase().includes(t));
                    });
                });

                const uniqueBrands = computed(() => [...new Set(dInfo.value.map(c => c.brand).filter(Boolean))]);
                const uniqueTypes = computed(() => [...new Set(dInfo.value.map(c => c.type).filter(Boolean))]);
                const historyData = computed(() => {
                    if(!selectedCar.value) return [];
                    let src = historyType.value === 'fuel' ? dFuel.value : dRepair.value;
                    return src.filter(r => r['รหัสรถ']===selectedCar.value.id).sort((a,b)=>toDate(b['วันที่'])-toDate(a['วันที่']));
                });

                // --- HELPER FUNCTIONS ---
                const parse = (v) => parseFloat((String(v)||'0').replace(/,/g,'')) || 0;
                const toDate = (s) => {
                    if(!s) return new Date(0);
                    s = String(s).trim();
                    if(s.includes('/')) { let p=s.split('/'); if(p.length===3) return new Date(p[2], p[1]-1, p[0]); }
                    else if(s.includes('-')) { let p=s.split('-'); if(p.length===3) return new Date(p[0], p[1]-1, p[2]); }
                    return new Date(0);
                };
                const checkDate = (s) => {
                    let d = toDate(s);
                    if(d.getTime() === new Date(0).getTime()) return 'ok';
                    let now = new Date(); now.setHours(0,0,0,0);
                    let diff = Math.ceil((d - now)/86400000);
                    if(diff < 0) return 'exp'; if(diff < 30) return 'near'; return 'ok';
                };
                const getStatusColor = (s) => { let st=checkDate(s); return st==='exp'?'#ef4444':(st==='near'?'#f59e0b':'#10b981'); };
                const formatTax = (s) => { let c=getStatusColor(s); return `<span style="color:${c};font-weight:bold">${s||'-'}</span>`; };

                // --- ACTIONS ---
                const nav = (p) => { 
                    currentPage.value = p; 
                    // Reset details
                    selectedCar.value = null; 
                    selectedProject.value = null; 
                    selectedShop.value = null;
                    selectedDetailList.value = null;
                    selectedVehicleFromChart.value = null;
                    if(['fuel','repair'].includes(p)) updateMainCharts(p);
                };

                const viewCar = (c) => { 
                    selectedCar.value = c; 
                    resetScope(infoFuelScope.value); resetScope(infoRepairScope.value);
                    nextTick(() => { updateInfoCharts(); });
                };
                const viewCarById = (id) => {
                    let c = dInfo.value.find(x => x.id === id);
                    if(!c) c = { id: id, plate: 'ไม่พบข้อมูล', brand: '-', type: '-', tax: '' };
                    viewCar(c);
                    // If inside shop detail, close it? No, keep context or redirect. 
                    // Simpler to redirect to Info tab
                    if(currentPage.value !== 'info') currentPage.value = 'info';
                };

                const viewProject = (name) => {
                    selectedProject.value = name;
                    resetScope(projFuelScope.value); resetScope(projRepairScope.value);
                    nextTick(() => { updateProjCharts(); });
                };

                const viewShop = (name) => { selectedShop.value = name; };
                const viewShopFromHistory = (name) => {
                    showHistoryModal.value = false;
                    nav('shops');
                    viewShop(name.trim());
                };

                const resetScope = (s) => { s.mode='year'; s.year=null; s.month=null; s.title='รายปี'; };
                const upScope = (ctxStr) => {
                    // Contexts: infoFuel, infoRepair, projFuel, projRepair, fuel, repair
                    let s;
                    if(ctxStr.startsWith('info')) s = ctxStr==='infoFuel'?infoFuelScope.value:infoRepairScope.value;
                    else if(ctxStr.startsWith('proj')) s = ctxStr==='projFuel'?projFuelScope.value:projRepairScope.value;
                    else s = scopes.value[ctxStr]; // Main charts

                    if(s.mode === 'day') { s.mode = 'month'; s.title = 'ปี '+s.year; }
                    else { s.mode = 'year'; s.title = 'รายปี'; }
                    
                    if(ctxStr.startsWith('info')) updateInfoCharts();
                    else if(ctxStr.startsWith('proj')) updateProjCharts();
                    else updateMainCharts(ctxStr);
                };

                const openHistory = (type) => { historyType.value = type; showHistoryModal.value = true; };
                const openRepeatModal = () => { showRepeatModal.value = true; };
                const checkOff = async (x) => {
                    if(!confirm('ยืนยันว่าตรวจสอบแล้ว?')) return;
                    // Optimistic UI update
                    let r = dRepair.value.find(r => r['รหัสรถ']===x.id && r['วันที่']===x.d2 && r.item===x.item);
                    if(r) r.checked = 'เช็คแล้ว';
                    try { await fetch(GAS_URL, {method:'POST', body:JSON.stringify({action:'checkRepair', carId:x.id, date:x.d2, item:x.item})}); } catch(e){}
                };

                const openEditModal = (c) => {
                    showEditModal.value = true;
                    if(c) editForm.value = { mode:'update', id:c.id, plate:c.plate, brand:c.brand, type:c.type, tax:c.tax, submitting:false };
                    else editForm.value = { mode:'add', id:'', plate:'', brand:'', type:'', tax:'', submitting:false };
                };
                const saveCar = async () => {
                    editForm.value.submitting = true;
                    let p = { action: editForm.value.mode, id: editForm.value.id, plate: editForm.value.plate, brand: editForm.value.brand, type: editForm.value.type, tax_expire: editForm.value.tax };
                    try { await fetch(GAS_URL, {method:'POST', body:JSON.stringify(p)}); } catch(e){}
                    // Simple refresh strategy: reload info or manually update array
                    await loadData(); // Reload all to be safe
                    showEditModal.value = false;
                };
                const delCar = async () => {
                    if(!confirm('ลบ?')) return;
                    try { await fetch(GAS_URL, {method:'POST', body:JSON.stringify({action:'delete', id:editForm.value.id})}); } catch(e){}
                    await loadData();
                    showEditModal.value = false;
                };

                const doCalc = () => {
                    let s = new Date(calcStart.value), t = parse(calcAmount.value);
                    if(isNaN(t)) return;
                    let ey = new Date(s.getFullYear(), 11, 31);
                    let d1 = Math.max(0, Math.ceil((ey-s)/86400000));
                    let c1 = (t/365)*d1;
                    calcResult.value = { res1: `${s.getFullYear()}: ${d1} วัน (${c1.toLocaleString(undefined,{maximumFractionDigits:2})} บ.)`, res2: `${s.getFullYear()+1}: ${365-d1} วัน (${(t-c1).toLocaleString(undefined,{maximumFractionDigits:2})} บ.)` };
                };

                // --- CHART LOGIC (Generic) ---
                const renderChart = (canvasRefName, type, data, valKey, color, onClick) => {
                    const canvas = instance.refs[canvasRefName];
                    if(!canvas) return;
                    
                    if(chartInstances[canvasRefName]) chartInstances[canvasRefName].destroy();
                    
                    // Aggregate Data
                    let g = {};
                    data.forEach(r => {
                        let dt = toDate(r['วันที่']);
                        if(dt.getTime()>0) {
                            let k;
                            // Simplify aggregation logic here, context passed via data preparation
                            // But here we receive raw data and need context to group.
                            // Better approach: Prepare labels/values BEFORE calling renderChart.
                        }
                    });
                };
                
                // Refactored Chart Logic to handle Scope internally
                const drawScopedChart = (canvasRefName, scope, rawData, valKey, color, drillDownFn) => {
                    const canvas = instance.refs[canvasRefName];
                    if(!canvas) return;
                    if(chartInstances[canvasRefName]) chartInstances[canvasRefName].destroy();

                    let data = rawData;
                    if(scope.mode === 'month') data = data.filter(r => toDate(r['วันที่']).getFullYear() == scope.year);
                    if(scope.mode === 'day') {
                         let mIdx = MONTHS.indexOf(scope.month);
                         data = data.filter(r => { let dt=toDate(r['วันที่']); return dt.getFullYear() == scope.year && dt.getMonth() == mIdx; });
                    }

                    let g = {};
                    data.forEach(r => {
                        let dt = toDate(r['วันที่']);
                        if(dt.getTime()>0) {
                            let k;
                            if(scope.mode === 'year') k = dt.getFullYear();
                            else if(scope.mode === 'month') k = MONTHS[dt.getMonth()];
                            else k = dt.getDate();
                            g[k] = (g[k]||0) + parse(r[valKey]);
                        }
                    });

                    let labels = Object.keys(g).sort((a,b)=>{
                        if(scope.mode === 'month') return MONTHS.indexOf(a)-MONTHS.indexOf(b);
                        return a-b;
                    });
                    
                    chartInstances[canvasRefName] = new Chart(canvas, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{ label: 'รวม', data: labels.map(l=>g[l]), backgroundColor: color, borderRadius: 4 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                            onClick: (e, el) => {
                                if(el.length > 0) {
                                    let label = labels[el[0].index];
                                    drillDownFn(label);
                                }
                            }
                        }
                    });
                };

                // Wrappers for specific charts
                const updateInfoCharts = () => {
                    if(!selectedCar.value) return;
                    let carDataFuel = dFuel.value.filter(x => x['รหัสรถ']===selectedCar.value.id);
                    let carDataRepair = dRepair.value.filter(x => x['รหัสรถ']===selectedCar.value.id);
                    
                    drawScopedChart('infoFuelChart', infoFuelScope.value, carDataFuel, 'ปริมาณ(ลิตร)', '#f59e0b', (label) => {
                        if(infoFuelScope.value.mode==='year') { infoFuelScope.value.mode='month'; infoFuelScope.value.year=label; infoFuelScope.value.title='ปี '+label; updateInfoCharts(); }
                        else if(infoFuelScope.value.mode==='month') { infoFuelScope.value.mode='day'; infoFuelScope.value.month=label; infoFuelScope.value.title='เดือน '+label; updateInfoCharts(); }
                    });
                    drawScopedChart('infoRepairChart', infoRepairScope.value, carDataRepair, 'ค่าใช้จ่าย', '#10b981', (label) => {
                        if(infoRepairScope.value.mode==='year') { infoRepairScope.value.mode='month'; infoRepairScope.value.year=label; infoRepairScope.value.title='ปี '+label; updateInfoCharts(); }
                        else if(infoRepairScope.value.mode==='month') { infoRepairScope.value.mode='day'; infoRepairScope.value.month=label; infoRepairScope.value.title='เดือน '+label; updateInfoCharts(); }
                    });
                };

                const updateProjCharts = () => {
                    if(!selectedProject.value) return;
                    let projDataFuel = dFuel.value.filter(x => x['โครงการ']===selectedProject.value);
                    let projDataRepair = dRepair.value.filter(x => x['โครงการ']===selectedProject.value);
                    
                    drawScopedChart('projFuelChart', projFuelScope.value, projDataFuel, 'ปริมาณ(ลิตร)', '#f59e0b', (label) => {
                        if(projFuelScope.value.mode==='year') { projFuelScope.value.mode='month'; projFuelScope.value.year=label; projFuelScope.value.title='ปี '+label; updateProjCharts(); }
                        else if(projFuelScope.value.mode==='month') { projFuelScope.value.mode='day'; projFuelScope.value.month=label; projFuelScope.value.title='เดือน '+label; updateProjCharts(); }
                    });
                    drawScopedChart('projRepairChart', projRepairScope.value, projDataRepair, 'ค่าใช้จ่าย', '#10b981', (label) => {
                        if(projRepairScope.value.mode==='year') { projRepairScope.value.mode='month'; projRepairScope.value.year=label; projRepairScope.value.title='ปี '+label; updateProjCharts(); }
                        else if(projRepairScope.value.mode==='month') { projRepairScope.value.mode='day'; projRepairScope.value.month=label; projRepairScope.value.title='เดือน '+label; updateProjCharts(); }
                    });
                };

                const updateMainCharts = (type) => {
                    nextTick(() => {
                        let state = scopes.value[type];
                        let raw = type==='fuel' ? dFuel.value : dRepair.value;
                        if(state.projectFilter !== 'all') raw = raw.filter(x => x['โครงการ']===state.projectFilter);
                        let valKey = type==='fuel' ? 'ปริมาณ(ลิตร)' : 'ค่าใช้จ่าย';
                        let color = type==='fuel' ? '#f59e0b' : '#10b981';

                        // Calculate filtered data for Summary & Top 10
                        let filteredData = raw;
                        if(state.mode === 'month') filteredData = raw.filter(r => toDate(r['วันที่']).getFullYear() == state.year);
                        if(state.mode === 'day') {
                            let mIdx = MONTHS.indexOf(state.month);
                            filteredData = raw.filter(r => { let dt=toDate(r['วันที่']); return dt.getFullYear() == state.year && dt.getMonth() == mIdx; });
                        }
                        
                        state.sum = filteredData.reduce((a,b)=>a+parse(b[valKey]), 0);
                        
                        // Top 10
                        let map = {};
                        filteredData.forEach(r => map[r['รหัสรถ']] = (map[r['รหัสรถ']]||0) + parse(r[valKey]));
                        state.top10 = Object.keys(map).sort((a,b)=>map[b]-map[a]).slice(0,10).map(id => ({id, val: map[id]}));

                        drawScopedChart(type+'Chart', state, raw, valKey, color, (label) => {
                            if(state.mode==='year') { state.mode='month'; state.year=label; state.title='ปี '+label; updateMainCharts(type); }
                            else if(state.mode==='month') { state.mode='day'; state.month=label; state.title='เดือน '+label; updateMainCharts(type); }
                            else {
                                // Day Click -> Show Detail List
                                let mIdx = MONTHS.indexOf(state.month);
                                let dStr = `${String(label).padStart(2,'0')}/${String(mIdx+1).padStart(2,'0')}/${state.year}`;
                                selectedDetailDate.value = dStr;
                                selectedDetailList.value = filteredData.filter(r => toDate(r['วันที่']).getDate() == label);
                            }
                        });
                    });
                };

                const viewVehicleFromChart = (type, id) => {
                    let car = dInfo.value.find(x => x.id === id);
                    if(!car) car = { id: id, plate: 'ไม่พบข้อมูล' };
                    selectedVehicleFromChart.value = car;
                    
                    nextTick(() => {
                        let raw = type==='fuel' ? dFuel.value : dRepair.value;
                        let valKey = type==='fuel' ? 'ปริมาณ(ลิตร)' : 'ค่าใช้จ่าย';
                        let color = type==='fuel' ? '#f59e0b' : '#10b981';
                        let carData = raw.filter(x => x['รหัสรถ']===id);
                        
                        // Always year mode for vehicle drilldown chart
                        drawScopedChart(type+'VehicleChart', {mode:'year'}, carData, valKey, color, ()=>{});
                    });
                };

                // Watch filters for main pages to redraw charts
                watch(() => scopes.value.fuel.projectFilter, () => { scopes.value.fuel.mode='year'; updateMainCharts('fuel'); });
                watch(() => scopes.value.repair.projectFilter, () => { scopes.value.repair.mode='year'; updateMainCharts('repair'); });

                // --- DATA LOADING ---
                const loadData = async () => {
                    loading.value = true;
                    try {
                        let [i, f, r] = await Promise.allSettled([
                            fetch(GAS_URL).then(res => res.json()).catch(() => fetch(INFO_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true}).data)),
                            fetch(FUEL_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true}).data),
                            fetch(REPAIR_CSV).then(r=>r.text()).then(t=>Papa.parse(t,{header:true}).data)
                        ]);

                        if(i.value) dInfo.value = Array.isArray(i.value) ? i.value.map(x=>({id:x.id||x['รหัส'], plate:x.plate||x['ทะเบียน'], brand:x.brand||x['ยี่ห้อรถ'], type:x.type||x['ประเภทรถ'], tax:x.tax_expire||x['วันที่ทะเบียนขาด']})) : [];
                        if(f.value) dFuel.value = f.value.filter(x=>x['วันที่']);
                        if(r.value) dRepair.value = r.value.filter(x=>x['วันที่']).map(x=>{
                            let placeKey = Object.keys(x).find(k => k.trim() === 'ซื้อ/ซ่อมที่' || k.trim() === 'ชื่อ/ซ่อมที่');
                            let itemKey = Object.keys(x).find(k => k.trim() === 'รายการซ่อม/เปลี่ยน');
                            let checkKey = Object.keys(x).find(k => k.trim() === 'ตรวจสอบ');
                            let phoneKey = Object.keys(x).find(k => k.trim() === 'เบอร์โทร');
                            return { ...x, item: itemKey?x[itemKey]:'', checked: checkKey?x[checkKey]:'', place: placeKey?x[placeKey]:'', phone: phoneKey?x[phoneKey]:'' };
                        });
                    } catch(e) { console.error(e); }
                    loading.value = false;
                };

                onMounted(() => {
                    loadData();
                });

                // Expose to template
                const instance = Vue.getCurrentInstance(); // For refs access
                return {
                    loading, currentPage, nav,
                    dInfo, dFuel, dRepair, dProjects, dShops,
                    totalFuel, totalRepair, countExp, countNear, repeatList,
                    searchInfo, filteredInfo, viewCar, selectedCar, getStatusColor, formatTax, openHistory, showHistoryModal, historyData, historyType,
                    selectedProject, viewProject, projFuelScope, projRepairScope, upScope,
                    selectedShop, searchShop, filteredShops, viewShop, shopFilterCar, shopFilterMonth, filteredShopRecords, viewCarById, viewShopFromHistory,
                    scopes, updateMainCharts, selectedDetailList, selectedDetailDate, selectedVehicleFromChart, viewVehicleFromChart,
                    searchAlerts, filteredAlerts, openEditModal, showEditModal, editForm, saveCar, delCar, uniqueBrands, uniqueTypes,
                    showRepeatModal, openRepeatModal, checkOff,
                    calcStart, calcAmount, doCalc, calcResult,
                    parse // Util
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
