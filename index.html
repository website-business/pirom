<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Machine Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- MODERN RESET & VARIABLES --- */
        :root {
            --primary: #4f46e5;
            --primary-glow: rgba(79, 70, 229, 0.4);
            --bg-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            --glass-bg: rgba(255, 255, 255, 0.9);
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 15px 20px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Prompt', sans-serif;
            margin: 0;
            padding: 0;
            background: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgba(79, 70, 229, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
        }

        /* --- LOADING SCREEN --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease-out, visibility 0.6s;
        }
        .spinner-main {
            width: 60px; height: 60px; border: 6px solid #e2e8f0;
            border-top: 6px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .loading-text { font-size: 1.2rem; color: var(--text-main); font-weight: 600; }
        .loading-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utility Class to Hide Elements initially */
        .hidden-initial { display: none; opacity: 0; transition: opacity 0.5s; }
        .fade-in-content { display: block; animation: fadeInSimple 0.8s forwards; }

        /* --- ANIMATIONS --- */
        @keyframes fadeInSimple { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .anim-fade { animation: fadeInSimple 0.4s ease-out forwards; }
        
        /* --- NAVBAR --- */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            padding: 0.5rem 1rem;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            display: flex; justify-content: center; gap: 10px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }
        .navbar.nav-minimized { transform: translateY(-85%); opacity: 0.6; }
        .navbar:hover, .navbar.nav-visible { transform: translateY(0) !important; opacity: 1 !important; }
        .nav-btn {
            border: none; background: transparent; cursor: pointer;
            color: var(--text-muted); font-family: 'Prompt', sans-serif; font-weight: 500;
            padding: 8px 20px; border-radius: 50px; transition: all 0.3s;
            display: flex; align-items: center; gap: 6px; font-size: 0.9rem;
        }
        .nav-btn:hover { color: var(--primary); background: rgba(79, 70, 229, 0.05); transform: translateY(-2px); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px var(--primary-glow); }

        /* --- CONTAINER --- */
        .container { max-width: 1200px; margin: 90px auto 40px; padding: 0 20px; }
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeInSimple 0.3s ease-out; }
        
        h2.page-title {
            font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center;
            background: linear-gradient(135deg, #1f2937 0%, #4f46e5 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* --- DASHBOARD CARDS --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .menu-card {
            background: var(--glass-bg); backdrop-filter: blur(10px); padding: 25px 30px; 
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: var(--shadow-sm);
            cursor: pointer; transition: all 0.2s; position: relative;
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
            text-align: left; min-height: 120px; 
        }
        .menu-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); background: #ffffff; border-color: rgba(79, 70, 229, 0.3); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; width: 100%; }
        .card-text-group { flex-grow: 1; }
        .card-title { font-size: 1rem; color: var(--text-muted); font-weight: 500; z-index: 2; }
        .card-stat-value { font-size: 2.2rem; font-weight: 700; color: var(--text-main); margin: 10px 0 5px 0; line-height: 1; z-index: 2; }
        .card-desc { font-size: 0.8rem; color: #9ca3af; margin-top: 5px; z-index: 2; }
        .card-icon-box {
            width: 50px; height: 50px; border-radius: 14px; background: var(--theme-bg); color: var(--theme-color);
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;
        }
        .card-bg-icon {
            position: absolute; bottom: -20px; right: -20px; font-size: 8rem; color: var(--theme-color);
            opacity: 0.05; transform: rotate(-15deg); transition: all 0.4s; z-index: 1;
        }
        .menu-card:hover .card-bg-icon { transform: rotate(0deg) scale(1.2); opacity: 0.1; }

        .c-blue { --theme-color: #3b82f6; --theme-bg: #eff6ff; }
        .c-orange { --theme-color: #f59e0b; --theme-bg: #fef3c7; }
        .c-green { --theme-color: #10b981; --theme-bg: #d1fae5; }
        .c-red { --theme-color: #ef4444; --theme-bg: #fee2e2; }
        .c-purple { --theme-color: #8b5cf6; --theme-bg: #f3e8ff; }

        /* --- ALERTS SPECIFIC --- */
        .alert-stat-row { font-size: 1.1rem; display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .alert-stat-item { display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .dashboard-alert-box {
            background: #fee2e2; color: #b91c1c; padding: 5px 10px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            display: none; animation: pulse 2s infinite; margin-top: 10px; width: fit-content;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fff; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); position: relative; animation: slideInUp 0.3s;
        }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-family: 'Prompt', sans-serif;
            font-size: 1rem; box-sizing: border-box;
        }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-glow); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .btn-secondary { background: #e5e7eb; color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        /* --- CHARTS WRAPPER --- */
        .charts-wrapper, .fuel-charts-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 900px) { .charts-wrapper, .fuel-charts-wrapper { grid-template-columns: 1fr; } }
        .chart-container { background: white; border-radius: 20px; padding: 20px; box-shadow: var(--shadow-sm); position: relative; border: 1px solid rgba(0,0,0,0.05); height: 360px; }
        .chart-internal-title { text-align: center; font-size: 1rem; color: var(--text-muted); font-weight: 600; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        
        /* --- UTILS & CONTROLS --- */
        .filter-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .chart-header-title { font-size: 1.2rem; font-weight: 600; color: var(--primary); }
        .controls-group { display: flex; gap: 10px; align-items: center; }
        .project-select { padding: 8px 15px; border-radius: 50px; border: 1px solid #e5e7eb; background: white; color: var(--text-main); font-family: 'Prompt', sans-serif; font-size: 0.9rem; cursor: pointer; outline: none; transition: all 0.2s; box-shadow: var(--shadow-sm); }
        .btn-back { background: white; border: 1px solid #e5e7eb; padding: 8px 20px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; color: var(--text-main); transition: all 0.2s; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-sm); }
        .btn-back:hover, .btn-back.active { background: #f9fafb; border-color: var(--primary); color: var(--primary); }
        .btn-import { background: #10b981; color: white; border: none; }
        .btn-import:hover { background: #059669; color: white; }
        
        .search-input {
            padding: 8px 15px; border-radius: 50px; border: 1px solid #e5e7eb;
            font-family: 'Prompt', sans-serif; width: 200px; transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--primary); outline: none; width: 250px; }

        /* --- LISTS & CARDS --- */
        .top10-list-container { background: white; border-radius: 20px; padding: 15px; box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); height: 360px; overflow-y: auto; }
        .top10-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; background: #f9fafb; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .top10-item:hover { background: #eff6ff; border-color: #bfdbfe; transform: translateX(3px); }
        .top10-rank { font-size: 0.9rem; font-weight: 700; color: #9ca3af; width: 25px; }
        .top10-info { flex-grow: 1; }
        .top10-id { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .top10-vol { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
        .top10-unit { font-size: 0.75rem; color: var(--text-muted); }

        .vehicle-view-container { background: white; border-radius: 20px; padding: 30px; box-shadow: var(--shadow-sm); margin-bottom: 30px; }
        .vv-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .vv-title-group { display: flex; align-items: center; gap: 15px; }
        .vv-icon-box { width: 60px; height: 60px; background: #eff6ff; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--primary); }
        .vv-id { font-size: 2rem; font-weight: 700; color: var(--text-main); line-height: 1; }
        .vv-subtitle { font-size: 1rem; color: var(--text-muted); margin-top: 5px; }
        .vv-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 16px; border: 1px solid #f3f4f6; }
        .vv-info-item { display: flex; flex-direction: column; gap: 5px; }
        .vv-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }
        .vv-value { font-size: 1.1rem; color: var(--text-main); font-weight: 600; }
        .vv-chart-box { height: 350px; position: relative; }

        /* --- FIXED: CARD SQUASHING ISSUE --- */
        .detail-card-grid, .fuel-detail-grid { display: flex; flex-direction: column; gap: 12px; padding: 10px 0; }
        .item-card, .fuel-card, .info-card { 
            background: white; border-radius: 12px; padding: 15px 25px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #f3f4f6; 
            display: flex; align-items: center; justify-content: space-between; 
            transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; 
            cursor: pointer; 
            flex-shrink: 0;
        }
        .item-card:hover, .fuel-card:hover, .info-card:hover { transform: translateX(3px); box-shadow: 0 5px 10px rgba(0,0,0,0.05); border-color: #bfdbfe; }
        .item-card::before, .fuel-card::before, .info-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--primary); }
        .fc-left { display: flex; align-items: center; gap: 20px; }
        .fc-icon { font-size: 2.2rem; color: #bfdbfe; margin: 0; }
        .fc-info { display: flex; flex-direction: column; gap: 4px; }
        .fc-id { font-size: 1.1rem; font-weight: 600; color: var(--text-main); }
        .fc-proj { display: inline-block; background: #f3f4f6; color: #4b5563; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; width: fit-content; }
        .fc-right { text-align: right; }
        .fc-vol { font-size: 1.6rem; font-weight: 700; color: var(--primary); line-height: 1; }
        .fc-unit { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }

        .table-card { background: white; border-radius: 20px; box-shadow: var(--shadow-sm); overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8fafc; padding: 18px 24px; text-align: left; color: var(--text-muted); font-weight: 600; }
        td { padding: 16px 24px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); }
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .tag-blue { background: #eff6ff; color: #2563eb; }
        .loading { text-align: center; padding: 60px; color: var(--text-muted); }
        .status-danger { color: #dc2626; font-weight: 600; }
        .status-warning { color: #d97706; font-weight: 600; }
        .status-ok { color: #059669; font-weight: 500; }
        .import-btn-container { text-align:center; padding: 20px; margin-bottom:20px; border: 1px dashed #ccc; border-radius:10px; background:#fafafa; }

        /* --- NEW: INFO SECTION CARD STYLES --- */
        .info-card::before { background: var(--primary); }
        .info-card .fc-icon { color: var(--primary-glow); }
        .info-card .fc-status { font-size: 0.85rem; font-weight: 500; }
        
        .info-charts-row {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;
        }
        @media (max-width: 900px) { .info-charts-row { grid-template-columns: 1fr; } }
        
        /* NEW: ACTION ROW FOR HISTORY BUTTONS */
        .vv-action-row { display: flex; gap: 10px; margin-bottom: 20px; }

        /* NEW: SUMMARY BOX FOR FUEL/REPAIR */
        .summary-box-container {
            display: flex; justify-content: flex-end; margin-bottom: 15px; margin-right: 10px;
        }
        .summary-box {
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05);
            display: flex; align-items: baseline; gap: 8px;
        }
        .sb-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .sb-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); line-height: 1; }
        .sb-unit { font-size: 0.85rem; color: var(--text-muted); }
        
        /* --- CALCULATOR STYLES --- */
        .calc-wrapper {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: var(--shadow-lg); max-width: 600px; margin: 0 auto;
        }
        .calc-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 30px; text-align: center; color: white; position: relative; overflow: hidden;
        }
        .calc-header h2 { font-size: 1.8rem; margin: 0; color: white; font-weight: 700; }
        .calc-header p { opacity: 0.9; margin-top: 5px; font-size: 0.95rem; }
        .calc-body { padding: 30px; }
        .calc-input-group { margin-bottom: 20px; }
        .calc-label { display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }
        .calc-input {
            width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #e2e8f0;
            font-size: 1rem; font-family: 'Prompt', sans-serif; transition: all 0.3s; box-sizing: border-box;
        }
        .calc-input:focus { outline: none; border-color: #8b5cf6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
        .calc-btn {
            width: 100%; background: #6366f1; color: white; padding: 15px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .calc-btn:hover { background: #4f46e5; transform: translateY(-2px); }
        .calc-result {
            margin-top: 30px; background: #f8fafc; border-radius: 16px; padding: 20px;
            border: 1px solid #f1f5f9; display: none;
        }
        .result-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
        .result-row:last-child { border-bottom: none; }
        .res-label { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .res-val { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        .res-total { color: #6366f1; font-size: 1.3rem; }

    </style>
</head>
<body>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="spinner-main"></div>
        <div class="loading-text">กำลังเริ่มต้นระบบ...</div>
        <div class="loading-sub">เชื่อมต่อฐานข้อมูลและดาวน์โหลดรายการ</div>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar hidden-initial" id="main-navbar">
        <button class="nav-btn active" onclick="showSection('home')"><i class="fas fa-th-large"></i> Dashboard</button>
        <button class="nav-btn" onclick="showSection('info')"><i class="fas fa-truck-monster"></i> ข้อมูลรถ</button>
        <button class="nav-btn" onclick="showSection('fuel')"><i class="fas fa-gas-pump"></i> น้ำมัน</button>
        <button class="nav-btn" onclick="showSection('repair')"><i class="fas fa-tools"></i> ซ่อมบำรุง</button>
        <button class="nav-btn" onclick="showSection('alerts')"><i class="fas fa-bell"></i> แจ้งเตือน</button>
        <button class="nav-btn" onclick="showSection('calc')" style="color: #8b5cf6;"><i class="fas fa-calculator"></i> คำนวณ</button>
    </nav>

    <div class="container hidden-initial" id="main-container">

        <!-- 1. DASHBOARD -->
        <div id="section-home" class="page-section active">
            <h2 class="page-title">ภาพรวมสถานะเครื่องจักร</h2>
            <div class="dashboard-grid">
                
                <div class="menu-card c-blue" onclick="showSection('info')">
                    <div class="card-top">
                        <div class="card-text-group">
                            <div class="card-title">จำนวนเครื่องจักร</div>
                            <div class="card-stat-value" id="dash-stat-cars">-</div>
                            <div class="card-desc">รายการทะเบียนทั้งหมด</div>
                        </div>
                        <div class="card-icon-box"><i class="fas fa-truck-monster"></i></div>
                    </div>
                    <i class="fas fa-truck-monster card-bg-icon"></i>
                </div>

                <div class="menu-card c-orange" onclick="showSection('fuel')">
                    <div class="card-top">
                        <div class="card-text-group">
                            <div class="card-title">บันทึกน้ำมัน</div>
                            <div class="card-stat-value" id="dash-stat-fuel">-</div>
                            <div class="card-desc">ปริมาณรวม (ลิตร)</div>
                        </div>
                        <div class="card-icon-box"><i class="fas fa-gas-pump"></i></div>
                    </div>
                    <i class="fas fa-gas-pump card-bg-icon"></i>
                </div>

                <div class="menu-card c-green" onclick="showSection('repair')">
                    <div class="card-top">
                        <div class="card-text-group">
                            <div class="card-title">บันทึกค่าซ่อม</div>
                            <div class="card-stat-value" id="dash-stat-repair">-</div>
                            <div class="card-desc">ยอดรวม (บาท)</div>
                        </div>
                        <div class="card-icon-box"><i class="fas fa-tools"></i></div>
                    </div>
                    <i class="fas fa-tools card-bg-icon"></i>
                </div>

                <div class="menu-card c-red" onclick="showSection('alerts')">
                    <div class="card-top">
                        <div class="card-text-group">
                            <div class="card-title">แจ้งเตือน</div>
                            <div class="alert-stat-row">
                                <div class="alert-stat-item" style="color:var(--danger)">
                                    <i class="fas fa-exclamation-circle"></i> หมดอายุ: <span id="dash-alert-expired">-</span>
                                </div>
                                <div class="alert-stat-item" style="color:var(--warning)">
                                    <i class="fas fa-clock"></i> ใกล้หมด: <span id="dash-alert-near">-</span>
                                </div>
                            </div>
                            <div class="dashboard-alert-box" id="dashboard-alert-box">! พบรายการแจ้งเตือน</div>
                        </div>
                        <div class="card-icon-box"><i class="fas fa-bell"></i></div>
                    </div>
                    <i class="fas fa-bell card-bg-icon"></i>
                </div>
                
                <!-- Calculator Shortcut Card -->
                <div class="menu-card c-purple" onclick="showSection('calc')">
                    <div class="card-top">
                        <div class="card-text-group">
                            <div class="card-title">เครื่องมือ</div>
                            <div class="card-stat-value" style="font-size: 1.5rem; margin-top:15px;">คำนวณ Prorate</div>
                            <div class="card-desc">คำนวณค่าใช้จ่ายข้ามปี</div>
                        </div>
                        <div class="card-icon-box"><i class="fas fa-calculator"></i></div>
                    </div>
                    <i class="fas fa-calculator card-bg-icon"></i>
                </div>

            </div>
        </div>

        <!-- 2. INFO SECTION (CARDS LAYOUT) -->
        <div id="section-info" class="page-section">
            <h2 class="page-title">ทะเบียนเครื่องจักร (รวม)</h2>
            
            <div class="filter-controls">
                <div class="chart-header-title" id="info-header-title">รายการรถทั้งหมด</div>
                <div class="controls-group">
                    <input type="text" id="info-search" class="search-input" placeholder="ค้นหาทะเบียน/รหัส..." onkeyup="searchVehicle('info-list-container', this.value)">
                    <button class="btn-back" id="info-back-btn" onclick="drillUpInfo()" style="display:none;">
                        <i class="fas fa-arrow-left"></i> ย้อนกลับ
                    </button>
                </div>
            </div>

            <!-- List View -->
            <div id="info-list-container" class="detail-card-grid">
                <div class="loading"><i class="fas fa-circle-notch fa-spin"></i> กำลังโหลดข้อมูล...</div>
            </div>

            <!-- Detailed View with Charts -->
            <div id="info-vehicle-view" class="vehicle-view-container" style="display:none;">
                <div class="vv-header">
                    <div class="vv-title-group">
                        <div class="vv-icon-box"><i class="fas fa-truck-monster"></i></div>
                        <div>
                            <div class="vv-id" id="info-vv-id">Loading...</div>
                            <div class="vv-subtitle">ข้อมูลรายละเอียดและการใช้งาน</div>
                        </div>
                    </div>
                </div>

                <div class="vv-info-grid">
                    <div class="vv-info-item"><span class="vv-label">ทะเบียน</span><span class="vv-value" id="info-vv-plate">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ยี่ห้อ</span><span class="vv-value" id="info-vv-brand">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ประเภท</span><span class="vv-value" id="info-vv-type">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">วันหมดภาษี</span><span class="vv-value" id="info-vv-tax">-</span></div>
                </div>

                <!-- ADDED: History Buttons -->
                <div class="vv-action-row">
                    <button class="btn-back" style="background:#fef3c7; color:#d97706; border:none;" onclick="openHistoryModal('fuel')">
                        <i class="fas fa-gas-pump"></i> ประวัติน้ำมันทั้งหมด
                    </button>
                    <button class="btn-back" style="background:#d1fae5; color:#059669; border:none;" onclick="openHistoryModal('repair')">
                        <i class="fas fa-tools"></i> ประวัติซ่อมทั้งหมด
                    </button>
                </div>

                <!-- Dual Charts with Drill Down -->
                <div class="info-charts-row">
                    <!-- Fuel Chart -->
                    <div class="chart-container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 class="chart-internal-title" id="info-fuel-chart-title" style="margin:0; color:var(--warning); border:none; text-align:left;">สถิติการใช้น้ำมัน (รายปี)</h3>
                            <button class="nav-btn" id="btn-back-info-fuel" onclick="drillUpInfoFuel()" style="padding: 4px 12px; font-size: 0.8rem; display:none; background:#fef3c7; color:#d97706;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                        <canvas id="infoVehicleFuelChart"></canvas>
                    </div>
                    
                    <!-- Repair Chart -->
                    <div class="chart-container">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 class="chart-internal-title" id="info-repair-chart-title" style="margin:0; color:var(--success); border:none; text-align:left;">สถิติค่าซ่อมบำรุง (รายปี)</h3>
                            <button class="nav-btn" id="btn-back-info-repair" onclick="drillUpInfoRepair()" style="padding: 4px 12px; font-size: 0.8rem; display:none; background:#d1fae5; color:#059669;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                        <canvas id="infoVehicleRepairChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. FUEL SECTION -->
        <div id="section-fuel" class="page-section">
            <h2 class="page-title">สถิติการใช้น้ำมัน</h2>
            <div class="filter-controls">
                <div class="chart-header-title" id="fuel-chart-title">ภาพรวมรายปี</div>
                <div class="controls-group">
                    <select id="fuel-project-filter" class="project-select" onchange="onProjectFilterChange()"><option value="all">รวมทุกโครงการ</option></select>
                    <button class="btn-back" id="fuel-back-btn" onclick="drillUpFuel()" style="display:none;"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                </div>
            </div>
            
            <!-- Summary Box Added Here -->
            <div class="summary-box-container">
                <div class="summary-box">
                    <div class="sb-label">รวม</div>
                    <div class="sb-value" id="fuel-summary-val">0</div>
                    <div class="sb-unit">ลิตร</div>
                </div>
            </div>

            <div class="fuel-charts-wrapper anim-fade" id="fuel-charts-wrapper">
                <div class="chart-container"><canvas id="fuelChart"></canvas></div>
                <div class="top10-list-container"><h3 class="chart-internal-title" id="fuel-top10-title">Top 10 รถที่ใช้น้ำมันสูงสุด</h3><div id="fuel-top10-list-content"></div></div>
            </div>
            <div id="fuel-vehicle-view" class="vehicle-view-container" style="display:none;">
                <div class="vv-header">
                    <div class="vv-title-group">
                        <div class="vv-icon-box"><i class="fas fa-truck-pickup"></i></div>
                        <div><div class="vv-id" id="vv-id">Loading...</div><div class="vv-subtitle" id="vv-subtitle">ข้อมูลการใช้น้ำมัน</div></div>
                    </div>
                    <button class="btn-back" id="btn-go-info-fuel" style="background:var(--primary); color:white; border:none; margin-left: 10px;">
                        <i class="fas fa-info-circle"></i> ดูข้อมูลรถคันนี้
                    </button>
                </div>
                <div class="vv-info-grid">
                    <div class="vv-info-item"><span class="vv-label">ทะเบียน</span><span class="vv-value" id="vv-plate">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ยี่ห้อ</span><span class="vv-value" id="vv-brand">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ประเภท</span><span class="vv-value" id="vv-type">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">วันหมดภาษี</span><span class="vv-value" id="vv-tax">-</span></div>
                </div>
                <h3 class="chart-internal-title" style="text-align:left;">สถิติการใช้น้ำมันของรถคันนี้</h3>
                <div class="vv-chart-box"><canvas id="vehicleChart"></canvas></div>
            </div>
            <div id="fuel-detail-container" style="display:none;" class="anim-fade"><div class="detail-card-grid" id="fuel-card-list"></div></div>
        </div>

        <!-- 4. REPAIR SECTION -->
        <div id="section-repair" class="page-section">
            <h2 class="page-title">สถิติค่าซ่อมบำรุง</h2>
            <div class="filter-controls">
                <div class="chart-header-title" id="repair-chart-title" style="color:#10b981;">ภาพรวมรายปี</div>
                <div class="controls-group">
                    <select id="repair-project-filter" class="project-select" onchange="onRepairProjectFilterChange()"><option value="all">รวมทุกโครงการ</option></select>
                    <button class="btn-back" id="repair-back-btn" onclick="drillUpRepair()" style="display:none;"><i class="fas fa-arrow-left"></i> ย้อนกลับ</button>
                </div>
            </div>

            <!-- Summary Box Added Here -->
            <div class="summary-box-container">
                <div class="summary-box">
                    <div class="sb-label">รวม</div>
                    <div class="sb-value" id="repair-summary-val" style="color:#10b981;">0</div>
                    <div class="sb-unit">บาท</div>
                </div>
            </div>

            <div class="charts-wrapper anim-fade" id="repair-charts-wrapper">
                <div class="chart-container"><canvas id="repairChart"></canvas></div>
                <div class="top10-list-container"><h3 class="chart-internal-title" id="repair-top10-title">Top 10 รถที่ค่าซ่อมสูงสุด</h3><div id="repair-top10-list-content"></div></div>
            </div>
            <div id="repair-vehicle-view" class="vehicle-view-container" style="display:none;">
                <div class="vv-header">
                    <div class="vv-title-group">
                        <div class="vv-icon-box" style="color:#10b981; background:#ecfdf5;"><i class="fas fa-tools"></i></div>
                        <div><div class="vv-id" id="vv-repair-id">Loading...</div><div class="vv-subtitle" id="vv-repair-subtitle">ข้อมูลค่าซ่อม</div></div>
                    </div>
                    <button class="btn-back" id="btn-go-info-repair" style="background:#10b981; color:white; border:none; margin-left: 10px;">
                        <i class="fas fa-info-circle"></i> ดูข้อมูลรถคันนี้
                    </button>
                </div>
                <div class="vv-info-grid">
                    <div class="vv-info-item"><span class="vv-label">ทะเบียน</span><span class="vv-value" id="vv-repair-plate">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ยี่ห้อ</span><span class="vv-value" id="vv-repair-brand">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">ประเภท</span><span class="vv-value" id="vv-repair-type">-</span></div>
                    <div class="vv-info-item"><span class="vv-label">วันหมดภาษี</span><span class="vv-value" id="vv-repair-tax">-</span></div>
                </div>
                <h3 class="chart-internal-title" style="text-align:left;">สถิติค่าซ่อมของรถคันนี้</h3>
                <div class="vv-chart-box"><canvas id="repairVehicleChart"></canvas></div>
            </div>
            <div id="repair-detail-container" style="display:none;" class="anim-fade"><div class="detail-card-grid" id="repair-card-list"></div></div>
        </div>

        <!-- 5. ALERTS SECTION -->
        <div id="section-alerts" class="page-section">
            <h2 class="page-title" style="color:var(--danger)">จัดการการแจ้งเตือน & ต่ออายุ</h2>
            
            <div class="filter-controls">
                <div class="controls-group">
                    <button class="btn-back active" onclick="renderAlertsTable('all')" id="btn-alert-all">ทั้งหมด</button>
                    <button class="btn-back" onclick="renderAlertsTable('expired')" id="btn-alert-exp" style="color:var(--danger)">หมดอายุ</button>
                    <button class="btn-back" onclick="renderAlertsTable('near')" id="btn-alert-near" style="color:var(--warning)">ใกล้หมด</button>
                </div>
                <div class="controls-group">
                    <input type="text" id="alert-search" class="search-input" placeholder="ค้นหา..." onkeyup="searchVehicle('table-alerts', this.value)">
                    <button class="btn-back" style="background:var(--primary); color:white; border:none;" onclick="openEditModal()">
                        <i class="fas fa-plus"></i> เพิ่มรถใหม่
                    </button>
                </div>
            </div>

            <div class="table-card">
                <div id="table-alerts" class="table-responsive">
                    <div class="loading">กำลังโหลดข้อมูล...</div>
                </div>
            </div>
        </div>

        <!-- 6. CALCULATOR SECTION -->
        <div id="section-calc" class="page-section">
            <h2 class="page-title" style="color:#8b5cf6;">เครื่องมือคำนวณ (Prorate)</h2>
            
            <div class="calc-wrapper">
                <div class="calc-header">
                    <h2>คำนวณค่าใช้จ่าย</h2>
                    <p>ระบบคำนวณส่วนแบ่งรายปี (Prorate)</p>
                </div>
                <div class="calc-body">
                    <div class="calc-input-group">
                        <label class="calc-label">วันที่เริ่ม / ต่อสัญญา</label>
                        <input type="date" id="calc-startDate" class="calc-input" onchange="calculateProrate()">
                    </div>
                    <div class="calc-input-group">
                        <label class="calc-label">ค่าใช้จ่ายรวม (บาท)</label>
                        <input type="number" id="calc-amount" class="calc-input" placeholder="0.00" onkeyup="calculateProrate()">
                    </div>
                    <button class="calc-btn" onclick="calculateProrate()">คำนวณผลลัพธ์</button>
                    
                    <div id="calc-result-area" class="calc-result">
                        <div class="result-row">
                            <div class="res-label" id="res-year1-label">ปี -</div>
                            <div class="res-val" style="color:#f59e0b;"><span id="res-year1-days">0</span> วัน / <span id="res-year1-cost">0.00</span> บ.</div>
                        </div>
                        <div class="result-row">
                            <div class="res-label" id="res-year2-label">ปี -</div>
                            <div class="res-val" style="color:#10b981;"><span id="res-year2-days">0</span> วัน / <span id="res-year2-cost">0.00</span> บ.</div>
                        </div>
                        <div class="result-row" style="margin-top:15px; border-top:2px dashed #e2e8f0; padding-top:15px;">
                            <div class="res-label">รวมทั้งหมด</div>
                            <div class="res-val res-total"><span id="res-total-cost">0.00</span> บ.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL (EDIT/ADD) -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top:0; color:var(--text-main);">แก้ไขข้อมูล</h3>
            <form id="editForm">
                <div class="form-group">
                    <label>รหัสรถ</label>
                    <input type="text" id="edit-id" class="form-control" placeholder="เช่น TR-01">
                </div>
                <div class="form-group">
                    <label>ทะเบียน * (ใช้เป็นคีย์หลัก)</label>
                    <input type="text" id="edit-plate" class="form-control">
                </div>
                <div class="form-group">
                    <label>ยี่ห้อ</label>
                    <input type="text" id="edit-brand" class="form-control" list="brand-list">
                    <datalist id="brand-list"></datalist> <!-- Auto-complete -->
                </div>
                <div class="form-group">
                    <label>ประเภทรถ</label>
                    <input type="text" id="edit-type" class="form-control" list="type-list">
                    <datalist id="type-list"></datalist> <!-- Auto-complete -->
                </div>
                <div class="form-group">
                    <label>วันหมดอายุภาษี (วว/ดด/ปปปป)</label>
                    <input type="text" id="edit-tax" class="form-control" placeholder="31/12/2025">
                </div>
                <input type="hidden" id="edit-ins"> 
                <div class="modal-actions">
                    <button type="button" class="btn-danger" id="btn-delete" style="display:none;" onclick="deleteVehicle()">ลบรายการ</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">ยกเลิก</button>
                    <button type="button" class="btn-primary" onclick="saveVehicle()">บันทึกข้อมูล</button>
                </div>
            </form>
        </div>
    </div>

    <!-- HISTORY MODAL (NEW) -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 600px; height: 80vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="historyModalTitle" style="margin:0; color:var(--text-main);">ประวัติ</h3>
                <button onclick="closeHistoryModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="historyList" style="overflow-y:auto; flex-grow:1; padding-right:5px; display:flex; flex-direction:column; gap:10px;">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // *** CONFIGURATION ***
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbz9knQB2Sptv6XiIICRLdGt-aUqt1ixteGmn-2mXNNIaECYJq66fR1LMjyoSm7bNglb/exec';
        
        // CSV Links
        const SHEET_INFO = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=0&single=true&output=csv';
        const SHEET_FUEL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=700157187&single=true&output=csv';
        const SHEET_REPAIR = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=1964968763&single=true&output=csv';

        const THAI_MONTHS = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];

        // --- STATE ---
        let fuelRawData = [], repairRawData = [], infoRawData = [];
        let fuelChartInstance, vehicleChartInstance, repairChartInstance, repairVehicleChartInstance;
        
        // Info Page State
        let infoState = { selectedVehicle: null };
        let infoVehicleFuelChart = null, infoVehicleRepairChart = null;
        let infoFuelState = { level: 'year', year: null, month: null };
        let infoRepairState = { level: 'year', year: null, month: null };

        let fuelState = { level: 'year', selectedYear: null, selectedMonth: null, selectedDay: null, selectedVehicle: null, selectedProject: 'all' };
        let repairState = { level: 'year', selectedYear: null, selectedMonth: null, selectedDay: null, selectedVehicle: null, selectedProject: 'all' };
        let currentAlertFilter = 'all';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            Chart.defaults.font.family = "'Prompt', sans-serif";
            Chart.defaults.color = '#6b7280';
            Chart.defaults.animation.duration = 500; 
            
            const navbar = document.getElementById('main-navbar');
            window.addEventListener('scroll', () => {
                if(window.scrollY > 50) navbar.classList.add('nav-minimized');
                else navbar.classList.remove('nav-minimized');
            });

            // Set default date for calculator
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('calc-startDate').value = `${yyyy}-${mm}-${dd}`;

            // *** LOADING SEQUENCE ***
            // Wait for all data to load before showing dashboard
            try {
                await Promise.all([
                    loadInfoData(),
                    loadFuelData(),
                    loadRepairData()
                ]);
            } catch (error) {
                console.error("Error loading data:", error);
            }

            // Hide Loading Screen & Show Content
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContainer = document.getElementById('main-container');
            const mainNavbar = document.getElementById('main-navbar');

            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
                mainNavbar.classList.remove('hidden-initial');
                mainContainer.classList.remove('hidden-initial');
                mainContainer.classList.add('fade-in-content');
            }, 600);


            // Link listeners
            document.getElementById('btn-go-info-fuel').addEventListener('click', () => {
                if(fuelState.selectedVehicle) {
                    showSection('info');
                    showInfoDetail(fuelState.selectedVehicle);
                }
            });

             document.getElementById('btn-go-info-repair').addEventListener('click', () => {
                if(repairState.selectedVehicle) {
                    showSection('info');
                    showInfoDetail(repairState.selectedVehicle);
                }
            });
        });

        // --- CALCULATOR LOGIC ---
        function calculateProrate() {
            const startDateInput = document.getElementById('calc-startDate').value;
            const totalAmount = parseFloat(document.getElementById('calc-amount').value);

            if (!startDateInput || isNaN(totalAmount)) return;

            const parts = startDateInput.split('-');
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1; 
            const d = parseInt(parts[2], 10);

            const startDate = new Date(y, m, d);
            const endOfYear = new Date(y, 11, 31);

            const diffTime = endOfYear - startDate;
            let daysYear1 = Math.round(diffTime / (1000 * 60 * 60 * 24));
            if (daysYear1 < 0) daysYear1 = 0;

            const daysTotal = 365; // Simplify for now
            const daysYear2 = daysTotal - daysYear1;

            const costPerDay = totalAmount / daysTotal;
            const costYear1 = daysYear1 * costPerDay;
            const costYear2 = totalAmount - costYear1;

            document.getElementById('res-year1-label').innerText = `ปี ${y}`;
            document.getElementById('res-year1-days').innerText = daysYear1;
            document.getElementById('res-year1-cost').innerText = costYear1.toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2});

            document.getElementById('res-year2-label').innerText = `ปี ${y+1}`;
            document.getElementById('res-year2-days').innerText = daysYear2;
            document.getElementById('res-year2-cost').innerText = costYear2.toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2});

            document.getElementById('res-total-cost').innerText = totalAmount.toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2});
            document.getElementById('calc-result-area').style.display = 'block';
        }

        // --- HISTORY MODAL LOGIC (NEW) ---
        function openHistoryModal(type) {
            const vehicleId = infoState.selectedVehicle;
            if (!vehicleId) return;

            document.getElementById('historyModal').style.display = 'flex';
            document.getElementById('historyModalTitle').innerText = (type === 'fuel' ? 'ประวัติน้ำมัน: ' : 'ประวัติซ่อม: ') + vehicleId;
            
            const listContainer = document.getElementById('historyList');
            listContainer.innerHTML = '<div class="loading">กำลังโหลด...</div>';

            // Filter Data
            let rawData = type === 'fuel' ? fuelRawData : repairRawData;
            let items = rawData.filter(r => r['รหัสรถ'] === vehicleId);

            // Sort by Date (Descending)
            items.sort((a, b) => {
                let da = a['วันที่'].split('/');
                let db = b['วันที่'].split('/');
                // Convert DD/MM/YYYY to Date object
                return new Date(db[2], db[1]-1, db[0]) - new Date(da[2], da[1]-1, da[0]);
            });

            let html = '';
            if (items.length === 0) {
                html = '<div style="text-align:center; padding:20px; color:#9ca3af;">ไม่มีข้อมูลประวัติ</div>';
            } else {
                items.forEach(r => {
                    let valKey = type === 'fuel' ? 'ปริมาณ(ลิตร)' : 'ค่าใช้จ่าย';
                    let unit = type === 'fuel' ? 'ลิตร' : 'บาท';
                    let val = parseFloat((r[valKey]||'0').replace(/,/g,'')).toLocaleString();
                    let icon = type === 'fuel' ? 'fa-gas-pump' : 'fa-tools';
                    let color = type === 'fuel' ? 'var(--warning)' : '#10b981'; // Orange or Green
                    
                    html += `
                    <div class="item-card" style="cursor:default; flex-shrink: 0;">
                        <div class="fc-left">
                            <div style="width:40px; text-align:center;"><i class="fas ${icon}" style="color:${color}; font-size:1.2rem;"></i></div>
                            <div class="fc-info">
                                <div class="fc-id" style="font-size:1rem;">${r['วันที่']}</div>
                                <div class="fc-proj">${r['โครงการ']||'-'}</div>
                            </div>
                        </div>
                        <div class="fc-right">
                            <div class="fc-vol" style="color:${color}; font-size:1.2rem;">${val}</div>
                            <div class="fc-unit">${unit}</div>
                        </div>
                    </div>`;
                });
            }
            listContainer.innerHTML = html;
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // --- SEARCH FUNCTION ---
        function searchVehicle(containerId, query) {
            query = query.toLowerCase();
            const container = document.getElementById(containerId);
            
            // Handle Table (Alerts)
            if (container.tagName === 'TABLE' || container.querySelector('table')) {
                const rows = container.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            } 
            // Handle Cards (Info)
            else {
                const cards = container.querySelectorAll('.info-card');
                cards.forEach(card => {
                    const text = card.innerText.toLowerCase();
                    card.style.display = text.includes(query) ? 'flex' : 'none';
                });
            }
        }

        // --- UPDATE AUTOCOMPLETE ---
        function updateDatalists() {
            const brands = new Set();
            const types = new Set();
            
            infoRawData.forEach(r => {
                if(r['ยี่ห้อรถ']) brands.add(r['ยี่ห้อรถ']);
                if(r['ประเภทรถ']) types.add(r['ประเภทรถ']);
            });

            const brandList = document.getElementById('brand-list');
            brandList.innerHTML = '';
            brands.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b;
                brandList.appendChild(opt);
            });

            const typeList = document.getElementById('type-list');
            typeList.innerHTML = '';
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                typeList.appendChild(opt);
            });
        }

        // --- DATA LOADING & GAS INTEGRATION ---
        function loadInfoData() {
            return new Promise((resolve, reject) => {
                if (GAS_API_URL) {
                    fetch(GAS_API_URL)
                    .then(response => response.json())
                    .then(data => {
                        infoRawData = data.map(item => ({
                            'รหัส': item.id || '', 
                            'ทะเบียน': item.plate,
                            'ยี่ห้อรถ': item.brand || '', 
                            'ประเภทรถ': item.type || '',
                            'วันที่ทะเบียนขาด': item.tax_expire
                        }));
                        processInfoData();
                        resolve();
                    })
                    .catch(e => {
                        console.error("GAS Load Error:", e);
                        document.getElementById('info-list-container').innerHTML = '<div style="text-align:center; color:red; padding:20px;">โหลดข้อมูลไม่สำเร็จ (ตรวจสอบ URL)</div>';
                        resolve(); // Resolve anyway so dashboard can load other parts
                    });
                } else {
                    Papa.parse(SHEET_INFO, {
                        download: true, header: true,
                        complete: res => {
                            infoRawData = res.data;
                            processInfoData();
                            resolve();
                        },
                        error: (err) => {
                            console.error(err);
                            resolve();
                        }
                    });
                }
            });
        }

        function processInfoData() {
            renderInfoCards(); // Changed from Table to Cards
            renderAlertsTable(currentAlertFilter);
            updateDashboardStats();
            updateDatalists(); // Populate autocomplete
        }

        // --- CRUD OPERATIONS (GAS) ---
        async function saveVehicle() {
            if (!GAS_API_URL) return alert("ฟังก์ชันแก้ไขต้องใช้ GAS Web App URL");
            const plate = document.getElementById('edit-plate').value;
            if(!plate) return alert('กรุณาระบุทะเบียน (Key)');

            const payload = {
                action: document.getElementById('edit-id').disabled ? 'update' : 'add',
                id: document.getElementById('edit-id').value,
                plate: plate,
                brand: document.getElementById('edit-brand').value,
                type: document.getElementById('edit-type').value,
                tax_expire: document.getElementById('edit-tax').value,
                insurance_expire: '' 
            };

            const btn = document.querySelector('#editModal .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = 'กำลังบันทึก...';
            btn.disabled = true;

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert(result.message);
                    closeEditModal();
                    loadInfoData(); 
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                console.error(e);
                alert('บันทึกสำเร็จ (อาจไม่ได้รับ Response JSON)');
                closeEditModal();
                loadInfoData();
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteVehicle() {
            if (!GAS_API_URL) return;
            if (!confirm('ยืนยันลบข้อมูล?')) return;

            const id = document.getElementById('edit-id').value;
            const payload = { action: 'delete', id: id };

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message);
                    closeEditModal();
                    loadInfoData();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (e) {
                alert('ส่งคำสั่งลบแล้ว');
                closeEditModal();
                loadInfoData();
            }
        }

        // --- NAVIGATION & UI ---
        function showSection(id) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${id}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const btns = document.querySelectorAll('.nav-btn');
            if(id==='home') btns[0].classList.add('active');
            if(id==='info') btns[1].classList.add('active');
            if(id==='fuel') btns[2].classList.add('active');
            if(id==='repair') btns[3].classList.add('active');
            if(id==='alerts') btns[4].classList.add('active');
            if(id==='calc') { /* No button to highlight if handled via onclick */ }

            if(id==='fuel') { if(fuelChartInstance) fuelChartInstance.resize(); if(vehicleChartInstance) vehicleChartInstance.resize(); }
            if(id==='repair') { if(repairChartInstance) repairChartInstance.resize(); if(repairVehicleChartInstance) repairVehicleChartInstance.resize(); }
            if(id==='alerts') renderAlertsTable('all');
        }

        function openEditModal(id = null) {
            document.getElementById('editModal').style.display = 'flex';
            if(id) {
                document.getElementById('modalTitle').innerText = 'แก้ไขข้อมูล: ' + id;
                let car = infoRawData.find(r => r['รหัส'] === id);
                if(!car) car = infoRawData.find(r => r['ทะเบียน'] === id);
                
                if(car) {
                    document.getElementById('edit-id').value = car['รหัส'] || '';
                    document.getElementById('edit-id').disabled = true; 
                    document.getElementById('edit-plate').value = car['ทะเบียน'] || '';
                    document.getElementById('edit-brand').value = car['ยี่ห้อรถ'] || '';
                    document.getElementById('edit-type').value = car['ประเภทรถ'] || '';
                    document.getElementById('edit-tax').value = car['วันที่ทะเบียนขาด'] || '';
                    document.getElementById('btn-delete').style.display = 'block';
                }
            } else {
                document.getElementById('modalTitle').innerText = 'เพิ่มรถใหม่';
                document.querySelectorAll('#editForm input').forEach(i => i.value = '');
                document.getElementById('edit-id').disabled = false;
                document.getElementById('btn-delete').style.display = 'none';
            }
        }

        function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }

        // --- DASHBOARD & ALERTS UI ---
        
        // NEW: INFO CARD RENDERER
        function renderInfoCards() {
            let html = '';
            infoRawData.forEach(r => {
                html += `
                <div class="info-card anim-fade" onclick="showInfoDetail('${r['รหัส']}')" style="flex-shrink: 0;">
                    <div class="fc-left">
                        <i class="fas fa-truck-monster fc-icon"></i>
                        <div class="fc-info">
                            <div class="fc-id">${r['รหัส']||'-'}</div>
                            <div class="fc-proj">${r['ทะเบียน']||'-'}</div>
                        </div>
                    </div>
                    <div class="fc-right">
                        <div class="fc-status">${formatDateStatus(r['วันที่ทะเบียนขาด'])}</div>
                    </div>
                </div>`;
            });
            document.getElementById('info-list-container').innerHTML = html;
        }

        // NEW: SHOW INFO DETAIL & DUAL CHARTS
        function showInfoDetail(id) {
            infoState.selectedVehicle = id;
            
            // Reset drill-down states
            infoFuelState = { level: 'year', year: null, month: null };
            infoRepairState = { level: 'year', year: null, month: null };

            document.getElementById('info-list-container').style.display = 'none';
            document.getElementById('info-vehicle-view').style.display = 'block';
            document.getElementById('info-back-btn').style.display = 'flex';
            document.getElementById('info-header-title').innerText = 'รายละเอียด: ' + id;

            // Populate Text Info
            let info = infoRawData.find(r => r['รหัส'] === id) || {};
            document.getElementById('info-vv-id').innerText = id;
            document.getElementById('info-vv-plate').innerText = info['ทะเบียน']||'-';
            document.getElementById('info-vv-brand').innerText = info['ยี่ห้อรถ']||'-';
            document.getElementById('info-vv-type').innerText = info['ประเภทรถ']||'-';
            document.getElementById('info-vv-tax').innerHTML = formatDateStatus(info['วันที่ทะเบียนขาด']);

            updateInfoFuelChart();
            updateInfoRepairChart();
        }

        // INFO CHART UPDATE FUNCTIONS
        function updateInfoFuelChart() {
            let items = fuelRawData.filter(r => r['รหัสรถ'] === infoState.selectedVehicle);
            let labels = [], values = [], titleText = "สถิติรายปี";
            let clickHandler = null;

            document.getElementById('btn-back-info-fuel').style.display = 'none';

            if (infoFuelState.level === 'year') {
                titleText = "สถิติรายปี";
                let map = {};
                items.forEach(r => { let y=r['วันที่'].split('/')[2]; map[y]=(map[y]||0)+parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')); });
                labels = Object.keys(map).sort(); values = labels.map(k=>map[k]);
                clickHandler = (e, els) => { 
                    if(els.length>0) { 
                        infoFuelState.year = labels[els[0].index]; 
                        infoFuelState.level = 'month'; 
                        updateInfoFuelChart(); 
                    } 
                };
            } else if (infoFuelState.level === 'month') {
                titleText = `ปี ${infoFuelState.year}`;
                document.getElementById('btn-back-info-fuel').style.display = 'block';
                let map = new Array(12).fill(0);
                items.filter(r => r['วันที่'].split('/')[2] === infoFuelState.year)
                     .forEach(r => map[parseInt(r['วันที่'].split('/')[1])-1] += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
                labels = THAI_MONTHS; values = map;
                clickHandler = (e, els) => { 
                    if(els.length>0) { 
                        infoFuelState.month = els[0].index; 
                        infoFuelState.level = 'day'; 
                        updateInfoFuelChart(); 
                    } 
                };
            } else if (infoFuelState.level === 'day') {
                titleText = `${THAI_MONTHS[infoFuelState.month]} ${infoFuelState.year}`;
                document.getElementById('btn-back-info-fuel').style.display = 'block';
                let days = new Date(infoFuelState.year, infoFuelState.month+1, 0).getDate();
                let map = new Array(days).fill(0);
                items.filter(r => r['วันที่'].split('/')[2] === infoFuelState.year && (parseInt(r['วันที่'].split('/')[1])-1) === infoFuelState.month)
                     .forEach(r => map[parseInt(r['วันที่'].split('/')[0])-1] += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
                labels = Array.from({length:days},(_,i)=>i+1); values = map;
                // No further drill down
            }

            document.getElementById('info-fuel-chart-title').innerText = titleText;
            const ctx = document.getElementById('infoVehicleFuelChart').getContext('2d');
            if(infoVehicleFuelChart) infoVehicleFuelChart.destroy();
            infoVehicleFuelChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'ลิตร', data: values, backgroundColor: 'rgba(245, 158, 11, 0.7)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, onClick: clickHandler, plugins:{legend:{display:false}} }
            });
        }

        function updateInfoRepairChart() {
            let items = repairRawData.filter(r => r['รหัสรถ'] === infoState.selectedVehicle);
            let labels = [], values = [], titleText = "สถิติรายปี";
            let clickHandler = null;

            document.getElementById('btn-back-info-repair').style.display = 'none';

            if (infoRepairState.level === 'year') {
                titleText = "สถิติรายปี";
                let map = {};
                items.forEach(r => { let y=r['วันที่'].split('/')[2]; map[y]=(map[y]||0)+parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')); });
                labels = Object.keys(map).sort(); values = labels.map(k=>map[k]);
                clickHandler = (e, els) => { 
                    if(els.length>0) { 
                        infoRepairState.year = labels[els[0].index]; 
                        infoRepairState.level = 'month'; 
                        updateInfoRepairChart(); 
                    } 
                };
            } else if (infoRepairState.level === 'month') {
                titleText = `ปี ${infoRepairState.year}`;
                document.getElementById('btn-back-info-repair').style.display = 'block';
                let map = new Array(12).fill(0);
                items.filter(r => r['วันที่'].split('/')[2] === infoRepairState.year)
                     .forEach(r => map[parseInt(r['วันที่'].split('/')[1])-1] += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
                labels = THAI_MONTHS; values = map;
                clickHandler = (e, els) => { 
                    if(els.length>0) { 
                        infoRepairState.month = els[0].index; 
                        infoRepairState.level = 'day'; 
                        updateInfoRepairChart(); 
                    } 
                };
            } else if (infoRepairState.level === 'day') {
                titleText = `${THAI_MONTHS[infoRepairState.month]} ${infoRepairState.year}`;
                document.getElementById('btn-back-info-repair').style.display = 'block';
                let days = new Date(infoRepairState.year, infoRepairState.month+1, 0).getDate();
                let map = new Array(days).fill(0);
                items.filter(r => r['วันที่'].split('/')[2] === infoRepairState.year && (parseInt(r['วันที่'].split('/')[1])-1) === infoRepairState.month)
                     .forEach(r => map[parseInt(r['วันที่'].split('/')[0])-1] += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
                labels = Array.from({length:days},(_,i)=>i+1); values = map;
            }

            document.getElementById('info-repair-chart-title').innerText = titleText;
            const ctx = document.getElementById('infoVehicleRepairChart').getContext('2d');
            if(infoVehicleRepairChart) infoVehicleRepairChart.destroy();
            infoVehicleRepairChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'บาท', data: values, backgroundColor: '#10b981', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, onClick: clickHandler, plugins:{legend:{display:false}} }
            });
        }

        function drillUpInfoFuel() {
            if(infoFuelState.level === 'day') infoFuelState.level = 'month';
            else if(infoFuelState.level === 'month') infoFuelState.level = 'year';
            updateInfoFuelChart();
        }

        function drillUpInfoRepair() {
            if(infoRepairState.level === 'day') infoRepairState.level = 'month';
            else if(infoRepairState.level === 'month') infoRepairState.level = 'year';
            updateInfoRepairChart();
        }

        function drillUpInfo() {
            document.getElementById('info-vehicle-view').style.display = 'none';
            document.getElementById('info-list-container').style.display = 'flex'; // grid
            document.getElementById('info-back-btn').style.display = 'none';
            document.getElementById('info-header-title').innerText = 'รายการรถทั้งหมด';
            // Clear Search
            document.getElementById('info-search').value = '';
            searchVehicle('info-list-container', '');
        }

        function renderAlertsTable(filter) {
            currentAlertFilter = filter;
            document.querySelectorAll('#section-alerts .btn-back').forEach(b => {b.style.background='white'; b.style.color='var(--text-main)';});
            if(filter==='all') document.getElementById('btn-alert-all').style.background='#e5e7eb';
            if(filter==='expired') { document.getElementById('btn-alert-exp').style.background='#fee2e2'; document.getElementById('btn-alert-exp').style.color='#b91c1c'; }
            if(filter==='near') { document.getElementById('btn-alert-near').style.background='#fef3c7'; document.getElementById('btn-alert-near').style.color='#d97706'; }

            let html = `<table><thead><tr><th>รหัส</th><th>ทะเบียน</th><th>ทะเบียนขาด</th><th>จัดการ</th></tr></thead><tbody>`;
            const today = new Date(); today.setHours(0,0,0,0);

            infoRawData.forEach(r => {
                let isExp = false, isNear = false;
                ['วันที่ทะเบียนขาด'].forEach(k => {
                    if(!r[k]) return;
                    let p = r[k].split('/');
                    if(p.length===3) {
                        let d = new Date(p[2], p[1]-1, p[0]);
                        let diff = Math.ceil((d-today)/(86400000));
                        if(diff < 0) isExp = true; else if(diff<=30) isNear = true;
                    }
                });

                let show = (filter==='all') || (filter==='expired' && isExp) || (filter==='near' && isNear && !isExp);
                if(show) {
                    let key = r['รหัส'] || r['ทะเบียน'];
                    html += `<tr><td><span class="tag tag-blue">${r['รหัส']||'-'}</span></td><td>${r['ทะเบียน']}</td><td>${formatDateStatus(r['วันที่ทะเบียนขาด'])}</td><td><button class="btn-back" style="padding:5px 10px;font-size:0.8rem" onclick="openEditModal('${key}')"><i class="fas fa-edit"></i></button></td></tr>`;
                }
            });
            html += `</tbody></table>`;
            document.getElementById('table-alerts').innerHTML = html;
        }

        function updateDashboardStats() {
            let exp=0, warn=0;
            const today = new Date(); today.setHours(0,0,0,0);
            infoRawData.forEach(r => {
                ['วันที่ทะเบียนขาด'].forEach(k => {
                    if(!r[k]) return;
                    let p = r[k].split('/');
                    if(p.length===3) {
                        let d = new Date(p[2], p[1]-1, p[0]);
                        let diff = Math.ceil((d-today)/(86400000));
                        if(diff < 0) exp++; else if(diff<=30) warn++;
                    }
                });
            });
            document.getElementById('dash-alert-expired').innerText = exp + ' คัน';
            document.getElementById('dash-alert-near').innerText = warn + ' คัน';
            document.getElementById('dash-stat-cars').innerText = infoRawData.length + ' คัน';
            document.getElementById('dashboard-alert-box').style.display = (exp>0||warn>0) ? 'block' : 'none';
        }

        // --- FUEL & REPAIR LOGIC (CSV) ---
        function loadFuelData() {
            return new Promise((resolve) => {
                Papa.parse(SHEET_FUEL, {
                    download: true, header: true,
                    complete: res => {
                        fuelRawData = res.data.filter(r => r['วันที่']);
                        populateProjectFilter('fuel', fuelRawData); 
                        updateFuelChart(); 
                        let total = 0; fuelRawData.forEach(r => total += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
                        document.getElementById('dash-stat-fuel').innerText = total.toLocaleString();
                        resolve();
                    },
                    error: (err) => { console.error(err); resolve(); }
                });
            });
        }

        function loadRepairData() {
            return new Promise((resolve) => {
                Papa.parse(SHEET_REPAIR, {
                    download: true, header: true,
                    complete: res => {
                        repairRawData = res.data.filter(r => r['วันที่']);
                        populateProjectFilter('repair', repairRawData);
                        updateRepairChart();
                        let total = 0; repairRawData.forEach(r => total += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
                        document.getElementById('dash-stat-repair').innerText = total.toLocaleString();
                        resolve();
                    },
                    error: (err) => { console.error(err); resolve(); }
                });
            });
        }

        function populateProjectFilter(type, data) {
            const projects = new Set();
            data.forEach(r => { if(r['โครงการ']) projects.add(r['โครงการ']); });
            const select = document.getElementById(`${type}-project-filter`);
            select.innerHTML = '<option value="all">รวมทุกโครงการ</option>';
            Array.from(projects).sort().forEach(p => {
                const opt = document.createElement('option'); opt.value = p; opt.innerText = p;
                select.appendChild(opt);
            });
        }

        function onProjectFilterChange() {
            fuelState.selectedProject = document.getElementById('fuel-project-filter').value;
            fuelState.level = 'year'; fuelState.selectedYear = null; fuelState.selectedMonth = null; fuelState.selectedDay = null; fuelState.selectedVehicle = null;
            updateFuelChart();
        }

        function updateFuelChart() {
            let contextData = fuelRawData;
            if (fuelState.selectedProject !== 'all') contextData = fuelRawData.filter(r => r['โครงการ'] === fuelState.selectedProject);

            // Update Summary
            let sumVal = 0;
            if (fuelState.level === 'year') {
                contextData.forEach(r => sumVal += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
            } else if (fuelState.level === 'month') {
                contextData = contextData.filter(r => r['วันที่'].split('/')[2] === fuelState.selectedYear);
                contextData.forEach(r => sumVal += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
            } else if (fuelState.level === 'day') {
                contextData = contextData.filter(r => r['วันที่'].split('/')[2] === fuelState.selectedYear && (parseInt(r['วันที่'].split('/')[1])-1) === fuelState.selectedMonth);
                contextData.forEach(r => sumVal += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
            } else if (fuelState.level === 'detail') {
                 let dStr = `${fuelState.selectedDay.toString().padStart(2,'0')}/${(fuelState.selectedMonth+1).toString().padStart(2,'0')}/${fuelState.selectedYear}`;
                 contextData = contextData.filter(r => r['วันที่']===dStr);
                 contextData.forEach(r => sumVal += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
            }
            document.getElementById('fuel-summary-val').innerText = sumVal.toLocaleString();


            document.getElementById('fuel-charts-wrapper').style.display = 'grid'; 
            document.getElementById('fuel-detail-container').style.display = 'none';
            document.getElementById('fuel-vehicle-view').style.display = 'none';

            let labels = [], dataValues = [], titleText = "", bgColor = 'rgba(245, 158, 11, 0.8)', clickHandler = null;

            if (fuelState.level === 'year') {
                titleText = "ปริมาณการใช้น้ำมันรายปี (ลิตร)";
                document.getElementById('fuel-back-btn').style.display = 'none';
                document.getElementById('fuel-top10-title').innerText = "Top 10 รถใช้น้ำมันสูงสุด (ทั้งหมด)";
                let yearMap = {};
                contextData.forEach(row => {
                    let p = row['วันที่'].split('/'); if(p.length===3) yearMap[p[2]] = (yearMap[p[2]]||0) + parseFloat((row['ปริมาณ(ลิตร)']||'0').replace(/,/g,''));
                });
                labels = Object.keys(yearMap).sort(); dataValues = labels.map(y => yearMap[y]);
                clickHandler = (e, els) => { if(els.length>0) { fuelState.selectedYear = labels[els[0].index]; fuelState.level = 'month'; updateFuelChart(); } };

            } else if (fuelState.level === 'month') {
                titleText = `ปริมาณปี ${fuelState.selectedYear}`;
                document.getElementById('fuel-back-btn').style.display = 'flex';
                document.getElementById('fuel-top10-title').innerText = `Top 10 รถใช้น้ำมันสูงสุด ปี ${fuelState.selectedYear}`;
                let yearData = contextData.filter(r => r['วันที่'].split('/')[2] === fuelState.selectedYear);
                contextData = yearData;
                let monthMap = new Array(12).fill(0);
                yearData.forEach(r => monthMap[parseInt(r['วันที่'].split('/')[1])-1] += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
                labels = THAI_MONTHS; dataValues = monthMap;
                clickHandler = (e, els) => { if(els.length>0) { fuelState.selectedMonth = els[0].index; fuelState.level = 'day'; updateFuelChart(); } };

            } else if (fuelState.level === 'day') {
                titleText = `รายวัน ${THAI_MONTHS[fuelState.selectedMonth]}`;
                document.getElementById('fuel-back-btn').style.display = 'flex';
                document.getElementById('fuel-top10-title').innerText = `Top 10 เดือน ${THAI_MONTHS[fuelState.selectedMonth]}`;
                let monthData = contextData.filter(r => r['วันที่'].split('/')[2] === fuelState.selectedYear && (parseInt(r['วันที่'].split('/')[1])-1) === fuelState.selectedMonth);
                contextData = monthData;
                let days = new Date(fuelState.selectedYear, fuelState.selectedMonth+1, 0).getDate();
                let dayMap = new Array(days).fill(0);
                monthData.forEach(r => dayMap[parseInt(r['วันที่'].split('/')[0])-1] += parseFloat((r['ปริมาณ(ลิตร)']||'0').replace(/,/g,'')));
                labels = Array.from({length:days},(_,i)=>i+1); dataValues = dayMap;
                clickHandler = (e, els) => { if(els.length>0) { fuelState.selectedDay = els[0].index+1; fuelState.level = 'detail'; updateFuelChart(); } };

            } else if (fuelState.level === 'detail') {
                document.getElementById('fuel-charts-wrapper').style.display = 'none';
                document.getElementById('fuel-detail-container').style.display = 'block';
                document.getElementById('fuel-back-btn').style.display = 'flex';
                let dStr = `${fuelState.selectedDay.toString().padStart(2,'0')}/${(fuelState.selectedMonth+1).toString().padStart(2,'0')}/${fuelState.selectedYear}`;
                document.getElementById('fuel-chart-title').innerText = `รายการวันที่ ${dStr}`;
                renderDetailCards('fuel', contextData.filter(r => r['วันที่']===dStr));
                return;

            } else if (fuelState.level === 'vehicle_detail') {
                document.getElementById('fuel-charts-wrapper').style.display = 'none';
                document.getElementById('fuel-vehicle-view').style.display = 'block';
                document.getElementById('fuel-back-btn').style.display = 'flex';
                let scope = fuelState.selectedYear ? `ปี ${fuelState.selectedYear}` : "ทั้งหมด";
                if(fuelState.selectedMonth!=null) scope = `${THAI_MONTHS[fuelState.selectedMonth]} ${fuelState.selectedYear}`;
                document.getElementById('fuel-chart-title').innerText = `รายละเอียด: ${fuelState.selectedVehicle}`;
                showVehicleDetail('fuel', fuelState.selectedVehicle, scope, contextData);
                return;
            }

            document.getElementById('fuel-chart-title').innerText = titleText;
            const ctx = document.getElementById('fuelChart').getContext('2d');
            if(fuelChartInstance) fuelChartInstance.destroy();
            fuelChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'ลิตร', data: dataValues, backgroundColor: bgColor, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, onClick: clickHandler, plugins: { legend: {display:false} } }
            });
            renderTop10List('fuel', contextData);
        }

        function onRepairProjectFilterChange() {
            repairState.selectedProject = document.getElementById('repair-project-filter').value;
            repairState.level = 'year'; repairState.selectedYear = null; repairState.selectedMonth = null; repairState.selectedDay = null; repairState.selectedVehicle = null;
            updateRepairChart();
        }

        function updateRepairChart() {
            let contextData = repairRawData;
            if (repairState.selectedProject !== 'all') contextData = repairRawData.filter(r => r['โครงการ'] === repairState.selectedProject);

            // Update Summary
            let sumVal = 0;
            if (repairState.level === 'year') {
                contextData.forEach(r => sumVal += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
            } else if (repairState.level === 'month') {
                contextData = contextData.filter(r => r['วันที่'].split('/')[2] === repairState.selectedYear);
                contextData.forEach(r => sumVal += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
            } else if (repairState.level === 'day') {
                contextData = contextData.filter(r => r['วันที่'].split('/')[2] === repairState.selectedYear && (parseInt(r['วันที่'].split('/')[1])-1) === repairState.selectedMonth);
                contextData.forEach(r => sumVal += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
            } else if (repairState.level === 'detail') {
                 let dStr = `${repairState.selectedDay.toString().padStart(2,'0')}/${(repairState.selectedMonth+1).toString().padStart(2,'0')}/${repairState.selectedYear}`;
                 contextData = contextData.filter(r => r['วันที่']===dStr);
                 contextData.forEach(r => sumVal += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
            }
            document.getElementById('repair-summary-val').innerText = sumVal.toLocaleString();


            document.getElementById('repair-charts-wrapper').style.display = 'grid'; 
            document.getElementById('repair-detail-container').style.display = 'none';
            document.getElementById('repair-vehicle-view').style.display = 'none';

            let labels = [], dataValues = [], titleText = "", bgColor = '#10b981', clickHandler = null;

            if (repairState.level === 'year') {
                titleText = "ค่าซ่อมรายปี (บาท)";
                document.getElementById('repair-back-btn').style.display = 'none';
                document.getElementById('repair-top10-title').innerText = "Top 10 ค่าซ่อมสูงสุด";
                let yearMap = {};
                contextData.forEach(row => {
                    let p = row['วันที่'].split('/'); if(p.length===3) yearMap[p[2]] = (yearMap[p[2]]||0) + parseFloat((row['ค่าใช้จ่าย']||'0').replace(/,/g,''));
                });
                labels = Object.keys(yearMap).sort(); dataValues = labels.map(y => yearMap[y]);
                clickHandler = (e, els) => { if(els.length>0) { repairState.selectedYear = labels[els[0].index]; repairState.level = 'month'; updateRepairChart(); } };

            } else if (repairState.level === 'month') {
                titleText = `ค่าซ่อมปี ${repairState.selectedYear}`;
                document.getElementById('repair-back-btn').style.display = 'flex';
                document.getElementById('repair-top10-title').innerText = `Top 10 ค่าซ่อมสูงสุด ปี ${repairState.selectedYear}`;
                let yearData = contextData.filter(r => r['วันที่'].split('/')[2] === repairState.selectedYear);
                contextData = yearData;
                let monthMap = new Array(12).fill(0);
                yearData.forEach(r => monthMap[parseInt(r['วันที่'].split('/')[1])-1] += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
                labels = THAI_MONTHS; dataValues = monthMap;
                clickHandler = (e, els) => { if(els.length>0) { repairState.selectedMonth = els[0].index; repairState.level = 'day'; updateRepairChart(); } };

            } else if (repairState.level === 'day') {
                titleText = `รายวัน ${THAI_MONTHS[repairState.selectedMonth]}`;
                document.getElementById('repair-back-btn').style.display = 'flex';
                document.getElementById('repair-top10-title').innerText = `Top 10 เดือน ${THAI_MONTHS[repairState.selectedMonth]}`;
                let monthData = contextData.filter(r => r['วันที่'].split('/')[2] === repairState.selectedYear && (parseInt(r['วันที่'].split('/')[1])-1) === repairState.selectedMonth);
                contextData = monthData;
                let days = new Date(repairState.selectedYear, repairState.selectedMonth+1, 0).getDate();
                let dayMap = new Array(days).fill(0);
                monthData.forEach(r => dayMap[parseInt(r['วันที่'].split('/')[0])-1] += parseFloat((r['ค่าใช้จ่าย']||'0').replace(/,/g,'')));
                labels = Array.from({length:days},(_,i)=>i+1); dataValues = dayMap;
                clickHandler = (e, els) => { if(els.length>0) { repairState.selectedDay = els[0].index+1; repairState.level = 'detail'; updateRepairChart(); } };

            } else if (repairState.level === 'detail') {
                document.getElementById('repair-charts-wrapper').style.display = 'none';
                document.getElementById('repair-detail-container').style.display = 'block';
                document.getElementById('repair-back-btn').style.display = 'flex';
                let dStr = `${repairState.selectedDay.toString().padStart(2,'0')}/${(repairState.selectedMonth+1).toString().padStart(2,'0')}/${repairState.selectedYear}`;
                document.getElementById('repair-chart-title').innerText = `รายการซ่อมวันที่ ${dStr}`;
                renderDetailCards('repair', contextData.filter(r => r['วันที่']===dStr));
                return;

            } else if (repairState.level === 'vehicle_detail') {
                document.getElementById('repair-charts-wrapper').style.display = 'none';
                document.getElementById('repair-vehicle-view').style.display = 'block';
                document.getElementById('repair-back-btn').style.display = 'flex';
                let scope = repairState.selectedYear ? `ปี ${repairState.selectedYear}` : "ทั้งหมด";
                if(repairState.selectedMonth!=null) scope = `${THAI_MONTHS[repairState.selectedMonth]} ${repairState.selectedYear}`;
                document.getElementById('repair-chart-title').innerText = `รายละเอียด: ${repairState.selectedVehicle}`;
                showVehicleDetail('repair', repairState.selectedVehicle, scope, contextData);
                return;
            }

            document.getElementById('repair-chart-title').innerText = titleText;
            const ctx = document.getElementById('repairChart').getContext('2d');
            if(repairChartInstance) repairChartInstance.destroy();
            repairChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'บาท', data: dataValues, backgroundColor: bgColor, borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, onClick: clickHandler, plugins: { legend: {display:false} } }
            });
            renderTop10List('repair', contextData);
        }

        // --- SHARED HELPERS ---
        function renderTop10List(type, data) {
            let map = {}, valKey = type==='fuel'?'ปริมาณ(ลิตร)':'ค่าใช้จ่าย';
            data.forEach(r => map[r['รหัสรถ']] = (map[r['รหัสรถ']]||0) + parseFloat((r[valKey]||'0').replace(/,/g,'')));
            let sorted = Object.keys(map).map(k=>({id:k, v:map[k]})).sort((a,b)=>b.v-a.v).slice(0,10);
            let html = '';
            sorted.forEach((item,i) => {
                html += `<div class="top10-item anim-fade" onclick="selectVehicle('${type}','${item.id}')"><div class="top10-rank">${i+1}</div><div class="top10-info"><div class="top10-id">${item.id}</div></div><div class="top10-val-box"><div class="top10-vol">${item.v.toLocaleString()}</div></div></div>`;
            });
            document.getElementById(`${type}-top10-list-content`).innerHTML = html || '<div style="text-align:center;padding:20px;color:#ccc">ไม่มีข้อมูล</div>';
        }

        function selectVehicle(type, id) {
            if (type === 'fuel') { fuelState.selectedVehicle = id; fuelState.level = 'vehicle_detail'; updateFuelChart(); }
            else { repairState.selectedVehicle = id; repairState.level = 'vehicle_detail'; updateRepairChart(); }
        }

        function renderDetailCards(type, items) {
            let valKey = type==='fuel'?'ปริมาณ(ลิตร)':'ค่าใช้จ่าย';
            let sorted = items.sort((a,b)=>parseFloat((b[valKey]||'0').replace(/,/g,''))-parseFloat((a[valKey]||'0').replace(/,/g,'')));
            let html = '';
            sorted.forEach(r => {
                let val = parseFloat((r[valKey]||'0').replace(/,/g,'')).toLocaleString();
                html += `<div class="item-card anim-fade" onclick="selectVehicle('${type}','${r['รหัสรถ']}')"><div class="fc-left"><i class="fas ${type==='fuel'?'fa-gas-pump':'fa-tools'} fc-icon" style="color:${type==='fuel'?'#bfdbfe':'#6ee7b7'}"></i><div class="fc-info"><div class="fc-id">${r['รหัสรถ']}</div><div class="fc-proj">${r['โครงการ']||'-'}</div></div></div><div class="fc-right"><div class="fc-vol" style="color:${type==='fuel'?'var(--primary)':'#10b981'}">${val}</div></div></div>`;
            });
            document.getElementById(`${type}-card-list`).innerHTML = html || '<div style="text-align:center;padding:20px;color:#ccc">ไม่มีรายการ</div>';
        }

        function showVehicleDetail(type, id, scope, contextData) {
            let prefix = type==='fuel'?'vv':'vv-repair';
            let info = infoRawData.find(r=>r['รหัส']===id)||{};
            document.getElementById(`${prefix}-id`).innerText = id;
            document.getElementById(`${prefix}-subtitle`).innerText = scope;
            document.getElementById(`${prefix}-plate`).innerText = info['ทะเบียน']||'-';
            document.getElementById(`${prefix}-brand`).innerText = info['ยี่ห้อรถ']||'-';
            document.getElementById(`${prefix}-type`).innerText = info['ประเภทรถ']||'-';
            document.getElementById(`${prefix}-tax`).innerHTML = formatDateStatus(info['วันที่ทะเบียนขาด']);
            
            let items = contextData.filter(r => r['รหัสรถ'] === id);
            let state = type==='fuel' ? fuelState : repairState;
            if (state.selectedYear) items = items.filter(r => r['วันที่'].split('/')[2] === state.selectedYear);
            if (state.selectedMonth != null) items = items.filter(r => (parseInt(r['วันที่'].split('/')[1])-1) === state.selectedMonth);

            let labels=[], values=[], labelTxt='';
            let valKey = type==='fuel'?'ปริมาณ(ลิตร)':'ค่าใช้จ่าย';

            if (state.selectedMonth != null) {
                labelTxt = 'รายวัน';
                let days = new Date(state.selectedYear, state.selectedMonth+1, 0).getDate();
                let map = new Array(days).fill(0);
                items.forEach(r => map[parseInt(r['วันที่'].split('/')[0])-1] += parseFloat((r[valKey]||'0').replace(/,/g,'')));
                labels = Array.from({length:days},(_,i)=>i+1); values = map;
            } else if (state.selectedYear) {
                labelTxt = 'รายเดือน';
                let map = new Array(12).fill(0);
                items.forEach(r => map[parseInt(r['วันที่'].split('/')[1])-1] += parseFloat((r[valKey]||'0').replace(/,/g,'')));
                labels = THAI_MONTHS; values = map;
            } else {
                labelTxt = 'รายปี';
                let map = {};
                items.forEach(r => { let y=r['วันที่'].split('/')[2]; map[y]=(map[y]||0)+parseFloat((r[valueKey]||'0').replace(/,/g,'')); });
                labels = Object.keys(map).sort(); values = labels.map(y=>map[y]);
            }

            let chartId = type==='fuel'?'vehicleChart':'repairVehicleChart';
            const ctx = document.getElementById(chartId).getContext('2d');
            let instance = type==='fuel'?vehicleChartInstance:repairVehicleChartInstance;
            if(instance) instance.destroy();
            let newChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: type==='fuel'?'ลิตร':'บาท', data: values, borderColor: type==='fuel'?'#4f46e5':'#10b981', fill:true, tension:0.3 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            if(type==='fuel') vehicleChartInstance = newChart; else repairVehicleChartInstance = newChart;
        }

        function drillUpRepair() {
            if (repairState.level === 'vehicle_detail') {
                if(repairState.selectedDay) repairState.level = 'detail';
                else if(repairState.selectedMonth != null) repairState.level = 'day';
                else if(repairState.selectedYear) repairState.level = 'month';
                else repairState.level = 'year';
                repairState.selectedVehicle = null;
            } else if (repairState.level === 'detail') repairState.level = 'day';
            else if (repairState.level === 'day') repairState.level = 'month';
            else if (repairState.level === 'month') { repairState.level = 'year'; repairState.selectedYear = null; }
            updateRepairChart();
        }

        function drillUpFuel() {
            if (fuelState.level === 'vehicle_detail') {
                if(fuelState.selectedDay) fuelState.level = 'detail';
                else if(fuelState.selectedMonth != null) fuelState.level = 'day';
                else if(fuelState.selectedYear) fuelState.level = 'month';
                else fuelState.level = 'year';
                fuelState.selectedVehicle = null;
            } else if (fuelState.level === 'detail') fuelState.level = 'day';
            else if (fuelState.level === 'day') fuelState.level = 'month';
            else if (fuelState.level === 'month') { fuelState.level = 'year'; fuelState.selectedYear = null; }
            updateFuelChart();
        }

        function formatDateStatus(str) {
            if(!str) return '-';
            let p = str.split('/'); if(p.length!==3) return str;
            let d = new Date(p[2], p[1]-1, p[0]);
            let today = new Date(); today.setHours(0,0,0,0);
            let diff = Math.ceil((d-today)/(86400000));
            if(diff < 0) return `<span class="status-danger"><i class="fas fa-exclamation-circle"></i> ${str}</span>`;
            if(diff <= 30) return `<span class="status-warning"><i class="fas fa-exclamation-triangle"></i> ${str}</span>`;
            return `<span class="status-ok"><i class="fas fa-check-circle"></i> ${str}</span>`;
        }
    </script>
</body>
</html>
