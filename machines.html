<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลเครื่องจักร - EMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        // แก้ไขลิ้งค์ข้อมูล "รวมรหัส" ที่นี่ (ไฟล์นี้ใช้แค่ลิ้งค์นี้)
        const URL_MAIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLxlqlfXntTk-z4x45kGjZ1OjHFnpCeaqjGZGpkfohr3difiJQsI-p-3iZwgyM7UO35kRztltMKgbd/pub?gid=0&single=true&output=csv";
        
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Prompt', 'sans-serif'] }, colors: { gray: { 850: '#1f2937', 900: '#111827' } } } } }
    </script>
    <style>body { background-color: #030712; color: #e5e7eb; } .glass-panel { background: rgba(30, 30, 45, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }</style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar (อัปเดตเพิ่มปุ่ม กลับหน้าหลัก) -->
    <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col hidden md:flex">
        <div class="p-6 border-b border-gray-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-blue-600 flex items-center justify-center text-white"><i class="fas fa-cubes"></i></div>
            <h1 class="text-xl font-bold text-white">EMS System</h1>
        </div>
        
        <nav class="flex-1 py-4 space-y-1">
            <!-- ปุ่มกลับหน้าหลัก -->
            <a href="index.html" class="flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white mb-4 transition-colors">
                <i class="fas fa-home w-6"></i> กลับหน้าหลัก
            </a>

            <div class="px-6 mb-2 text-xs text-gray-500 font-bold uppercase">Database</div>
            <a href="machines.html" class="flex items-center px-6 py-3 bg-blue-900/20 text-blue-400 border-r-2 border-blue-500 transition-colors">
                <i class="fas fa-truck-moving w-6"></i> ข้อมูลเครื่องจักร
            </a>
            <a href="tax.html" class="flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                <i class="fas fa-file-invoice-dollar w-6"></i> แจ้งเตือนภาษี
            </a>
            <a href="projects.html" class="flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                <i class="fas fa-building w-6"></i> โครงการ
            </a>
            
            <div class="px-6 mt-6 mb-2 text-xs text-gray-500 font-bold uppercase">Analytics</div>
            <a href="fuel.html" class="flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                <i class="fas fa-gas-pump w-6"></i> สรุปน้ำมัน
            </a>
            <a href="maintenance.html" class="flex items-center px-6 py-3 text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                <i class="fas fa-tools w-6"></i> สรุปซ่อมบำรุง
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative">
        <header class="h-16 bg-gray-900/50 border-b border-gray-800 flex items-center justify-between px-6">
            <h2 class="text-lg font-medium text-white">ข้อมูลเครื่องจักร</h2>
            <div id="status" class="text-xs text-gray-500">Connecting...</div>
        </header>

        <div class="p-6 overflow-y-auto h-full pb-20">
            <div class="mb-6 relative">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                <input type="text" id="search" placeholder="ค้นหาทะเบียน, รหัส..." class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 pl-12 pr-4 text-gray-200 outline-none focus:border-blue-500" onkeyup="filterData()">
            </div>
            <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-gray-900 border border-gray-700 w-full max-w-lg rounded-2xl p-6 relative">
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 id="modalTitle" class="text-xl font-bold text-white mb-4">Detail</h3>
            <div id="modalContent" class="space-y-2 text-sm overflow-y-auto max-h-[60vh]"></div>
        </div>
    </div>

    <script>
        let rawData = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            Papa.parse(URL_MAIN, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    rawData = results.data;
                    renderGrid(rawData);
                    document.getElementById('status').innerHTML = `<span class="text-green-500">● Online</span> (${rawData.length} คัน)`;
                }
            });
        });

        function renderGrid(data) {
            const grid = document.getElementById('grid');
            grid.innerHTML = data.map(item => {
                const id = item.id || item.code || item['รหัส'] || item['ลำดับ'] || '-';
                const plate = item.plate || item.registration || item['ทะเบียน'] || 'No Plate';
                const type = item.type || item.category || item['ประเภท'] || '-';
                const status = item.status || item['สถานะ'] || 'Unknown';
                let color = status.includes('พร้อม') ? 'bg-green-500' : status.includes('ซ่อม') ? 'bg-red-500' : 'bg-blue-500';
                
                return `
                <div class="glass-panel p-5 rounded-xl border border-gray-800 group hover:border-blue-500/50 transition-all cursor-pointer" onclick='showDetail(${JSON.stringify(item)})'>
                    <div class="flex justify-between mb-3">
                        <div class="h-10 w-10 rounded bg-gray-800 flex items-center justify-center text-gray-400"><i class="fas fa-truck-moving"></i></div>
                        <span class="text-xs bg-gray-900 px-2 py-1 rounded text-gray-500 border border-gray-800">${id}</span>
                    </div>
                    <h3 class="font-bold text-gray-200 group-hover:text-blue-400 transition-colors">${plate}</h3>
                    <p class="text-sm text-gray-500 mb-4">${type}</p>
                    <div class="pt-3 border-t border-gray-700/50 flex items-center gap-2 text-xs text-gray-400">
                        <div class="w-2 h-2 rounded-full ${color}"></div> ${status}
                    </div>
                </div>`;
            }).join('');
        }

        function filterData() {
            const q = document.getElementById('search').value.toLowerCase();
            const filtered = rawData.filter(item => Object.values(item).join(' ').toLowerCase().includes(q));
            renderGrid(filtered);
        }

        function showDetail(item) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modalTitle').textContent = item.plate || item['ทะเบียน'] || 'Machine Info';
            document.getElementById('modalContent').innerHTML = Object.entries(item).map(([k,v]) => 
                `<div class="flex justify-between border-b border-gray-800 py-2"><span class="text-gray-500">${k}</span><span class="text-gray-300 text-right">${v}</span></div>`
            ).join('');
        }
    </script>
</body>
</html>